(function(){function h(a){window.llm.enableNavBlocker();y.innerHTML='<div class="has-text-info"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i> Unsaved Changes</div>';m&&a&&"number"===a.currentTarget.type&&(m.getElementsByTagName("fieldset")[0].setAttribute("disabled","disabled"),v=!0)}function L(a){a.currentTarget.closest(".panel-block").remove();v=!0;h()}function I(a){var c="";if(a)if(a instanceof Date)c=a.getFullYear()+"-"+("00"+(a.getMonth()+1)).slice(-2)+"-"+("00"+a.getDate()).slice(-2);
else if(a.constructor===String)c=a;else if(a instanceof Object)try{a.preventDefault();var d=a.currentTarget.getAttribute("data-source"),c=document.getElementById(d).value}catch(S){}n.insertAdjacentHTML("beforeend",'<div class="panel-block is-block"><div class="field has-addons">'+('<div class="control is-expanded has-icons-left"><input class="input is-small" name="eventDate" type="date" value="'+c+'" min="'+p.value+'" max="'+f.value+'" required /><span class="icon is-left"><i class="fas fa-calendar" aria-hidden="true"></i></span></div>')+
'<div class="control"><a class="button is-small is-danger has-tooltip-right" role="button" data-tooltip="Remove Event"><i class="fas fa-trash" aria-hidden="true"></i><span class="sr-only">Remove Event</span></a></div></div></div>');a=n.getElementsByTagName("a");a[a.length-1].addEventListener("click",L);v=!0;h()}var z=document.getElementById("form--licence"),y=document.getElementById("container--form-message"),A=document.getElementById("licence--licenceID").value,w=""===A,m=document.getElementById("form--licenceFee"),
v=!1,n=document.getElementById("container--events");z.addEventListener("submit",function(a){a.preventDefault();0===n.getElementsByTagName("input").length?window.llm.alertModal("Event Date Error","Please ensure there is at least one event date.","OK","warning"):(y.innerHTML='Saving... <i class="fas fa-circle-notch fa-spin" aria-hidden="true"></i>',window.fetch("/licences/doSave",{method:"POST",credentials:"include",body:new URLSearchParams(new FormData(z))}).then(function(a){return a.json()}).then(function(a){a.success&&
window.llm.disableNavBlocker();a.success&&w?window.location.href="/licences/"+a.licenceID+"/edit":a.success&&v?window.location.reload(!0):(y.innerHTML="",window.llm.alertModal(a.message,"","OK",a.success?"success":"danger"))}))});w||document.getElementsByClassName("is-delete-button")[0].addEventListener("click",function(a){a.preventDefault();window.llm.confirmModal("Delete Licence?","Are you sure you want to delete this licence and all events associated with it?","Yes, Delete","danger",function(){window.fetch("/licences/doDelete",
{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({licenceID:A})}).then(function(a){return a.json()}).then(function(a){a.success&&(window.llm.disableNavBlocker(),window.location.href="/licences")})})});for(var b=z.querySelectorAll("input, select, textarea"),e=0;e<b.length;e+=1)""!==b[e].name&&b[e].addEventListener("change",h);b=document.getElementsByClassName("is-external-licence-number-unlock-button");b.length&&b[0].addEventListener("click",function(){var a=
document.getElementById("licence--externalLicenceNumber");a.classList.remove("has-background-light");a.classList.remove("has-cursor-not-allowed");a.removeAttribute("readonly");a.focus()});var x=[],J,q,B,M=function(a){a.preventDefault();a=a.currentTarget;document.getElementById("licence--organizationID").value=a.getAttribute("data-organization-id");document.getElementById("licence--organizationName").value=a.getAttribute("data-organization-name");J();h()},C=function(){var a=document.createElement("div");
a.className="list is-hoverable";for(var c=q.value.trim().toLowerCase().split(" "),d=10,b=0;b<x.length&&0<d;b+=1){var g=!0,e=x[b];if(e.isEligibleForLicences){for(var N=e.organizationName.toLowerCase(),f=0;f<c.length;f+=1)if(-1===N.indexOf(c[f])){g=!1;break}g&&(--d,g=document.createElement("a"),g.className="list-item",g.setAttribute("data-organization-id",e.organizationID),g.setAttribute("data-organization-name",e.organizationName),g.innerText=e.organizationName,g.addEventListener("click",M),a.insertAdjacentElement("beforeend",
g))}}window.llm.clearElement(B);B.insertAdjacentElement("beforeend",a)};document.getElementById("is-organization-lookup-button").addEventListener("click",function(){window.llm.openHtmlModal("licenceOrganizationLookup",{onshow:function(){q=document.getElementById("organizationLookup--searchStr");q.addEventListener("keyup",C);B=document.getElementById("container--organizationLookup");0===x.length?window.fetch("/organizations/doGetAll",{method:"GET",credentials:"include"}).then(function(a){return a.json()}).then(function(a){x=
a;q.removeAttribute("disabled");C()}):(q.removeAttribute("disabled"),C())},onshown:function(a,c){J=c}})});var r=[],D,t,E,K=function(a,c){document.getElementById("licence--locationID").value=a;document.getElementById("licence--locationDisplayName").value=c},O=function(a){a.preventDefault();a=a.currentTarget;K(a.getAttribute("data-location-id"),a.getAttribute("data-location-display-name"));D();h()},F=function(){var a=document.createElement("div");a.className="list is-hoverable";for(var c=t.value.trim().toLowerCase().split(" "),
d=10,e=0;e<r.length&&0<d;e+=1){for(var g=!0,b=r[e],f=b.locationName.toLowerCase(),h=0;h<c.length;h+=1)if(-1===f.indexOf(c[h])){g=!1;break}g&&(--d,g=""===b.locationName?b.locationAddress1:b.locationName,f=document.createElement("a"),f.className="list-item",f.setAttribute("data-location-id",b.locationID),f.setAttribute("data-location-display-name",g),f.innerHTML=g+(""===b.locationName?"":"<br /><small>"+b.locationAddress1+"</small>"),f.addEventListener("click",O),a.insertAdjacentElement("beforeend",
f))}window.llm.clearElement(E);E.insertAdjacentElement("beforeend",a)};document.getElementById("is-location-lookup-button").addEventListener("click",function(){window.llm.openHtmlModal("licenceLocationLookup",{onshow:function(a){t=document.getElementById("locationLookup--searchStr");t.addEventListener("keyup",F);E=document.getElementById("container--locationLookup");0===r.length?window.fetch("/locations/doGetLocations",{method:"GET",credentials:"include"}).then(function(a){return a.json()}).then(function(a){r=
a;t.removeAttribute("disabled");F()}):(t.removeAttribute("disabled"),F());window.llm.initializeTabs(a.querySelector(".tabs ul"));document.getElementById("form--newLocation").addEventListener("submit",function(a){a.preventDefault();window.fetch("/locations/doCreate",{method:"POST",credentials:"include",body:new URLSearchParams(new FormData(a.currentTarget))}).then(function(a){return a.json()}).then(function(a){a.success&&(r=[],K(a.locationID,a.locationDisplayName),D())})})},onshown:function(a,c){D=
c}})});var k=[],G=document.getElementById("is-termsConditions-lookup-modal"),u=document.getElementById("container--termsConditionsPrevious"),P=function(a){a.preventDefault();a=parseInt(a.currentTarget.getAttribute("data-terms-conditions-index"));document.getElementById("licence--termsConditions").value=k[a].termsConditions;window.llm.hideModal(G);h()};document.getElementById("is-termsConditions-lookup-button").addEventListener("click",function(){k=[];window.llm.clearElement(u);var a=document.getElementById("licence--organizationID").value;
""===a?window.llm.alertModal("No Organization Selected","An organization must be selected before the previously used terms and conditions can be retrieved.","OK","warning"):(u.innerHTML='<p class="has-text-centered has-text-grey-lighter"><i class="fas fa-3x fa-circle-notch fa-spin" aria-hidden="true"></i><br />Loading previously used terms and conditions...</p>',window.fetch("/licences/doGetDistinctTermsConditions",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({organizationID:a})}).then(function(a){return a.json()}).then(function(a){k=
a;if(0===k.length)u.innerHTML='<p class="has-text-centered">No previously used terms and conditions found for this organization.</p>';else{a=document.createElement("div");a.className="list is-hoverable has-margin-bottom-10";for(var d=0;d<k.length;d+=1){var c=k[d],b=document.createElement("a");b.className="list-item";b.setAttribute("data-terms-conditions-index",d);b.innerHTML="<p>"+window.llm.escapeHTML(c.termsConditions)+'</p><p class="has-text-right">'+(1<c.termsConditionsCount?'<span class="tag is-light">Used '+
c.termsConditionsCount+" times</span>":"")+'<span class="tag is-info">'+c.startDateMaxString+"</span></p>";b.addEventListener("click",P);a.insertAdjacentElement("beforeend",b)}window.llm.clearElement(u);u.insertAdjacentElement("beforeend",a)}}),window.llm.showModal(G))});b=G.getElementsByClassName("is-close-modal-button");for(e=0;e<b.length;e+=1)b[e].addEventListener("click",window.llm.hideModal);if(w){var b=document.getElementById("licence--licenceTypeKey"),l=document.getElementsByClassName("container-licenceTypeFields");
b.addEventListener("change",function(a){"true"===a.currentTarget.selectedOptions[0].getAttribute("data-has-ticket-types")?document.getElementById("is-ticket-types-panel").classList.remove("is-hidden"):document.getElementById("is-ticket-types-panel").classList.add("is-hidden");a="container-licenceTypeFields--"+a.currentTarget.value;for(var c=0;c<l.length;c+=1)l[c].id===a?(l[c].removeAttribute("disabled"),l[c].classList.remove("is-hidden")):(l[c].classList.add("is-hidden"),l[c].setAttribute("disabled",
"disabled"))})}var p=document.getElementById("licence--startDateString"),f=document.getElementById("licence--endDateString");document.getElementById("licence--applicationDateString").addEventListener("change",function(a){p.setAttribute("min",a.currentTarget.value)});p.addEventListener("change",function(){var a=p.value;f.setAttribute("min",a);f.value<a&&(f.value=a);for(var c=n.getElementsByTagName("input"),b=0;b<c.length;b+=1)c[b].setAttribute("min",a)});f.addEventListener("change",function(){for(var a=
f.value,b=n.getElementsByTagName("input"),d=0;d<b.length;d+=1)b[d].setAttribute("max",a)});var H=document.getElementById("is-event-calculator-modal");document.getElementsByClassName("is-calculate-events-button")[0].addEventListener("click",function(){for(var a=parseInt(document.getElementById("eventCalc--eventCount").value),b=parseInt(document.getElementById("eventCalc--dayInterval").value),d=f.value.split("-"),e=new Date(d[0],parseInt(d[1])-1,d[2]),d=p.value.split("-"),d=new Date(d[0],parseInt(d[1])-
1,d[2]),g=0;g<a&&d.getTime()<=e.getTime();g+=1)I(d),d.setDate(d.getDate()+b);window.llm.hideModal(H)});document.getElementById("is-event-calculator-button").addEventListener("click",function(){window.llm.showModal(H)});b=H.getElementsByClassName("is-close-modal-button");for(e=0;e<b.length;e+=1)b[e].addEventListener("click",window.llm.hideModal);b=document.getElementsByClassName("is-add-event-button");for(e=0;e<b.length;e+=1)b[e].addEventListener("click",I);if(!w)if(m){var Q=function(){window.fetch("/licences/doMarkLicenceFeePaid",
{method:"POST",credentials:"include",body:new URLSearchParams(new FormData(m))}).then(function(a){return a.json()}).then(function(a){a.success&&(window.llm.disableNavBlocker(),window.location.reload(!0))})};m.addEventListener("submit",function(a){a.preventDefault();window.llm.confirmModal("Mark Fee as Paid?","Are you sure you want to mark the licence fee as paid?","Yes, Paid","info",Q)})}else{var R=function(){window.fetch("/licences/doRemoveLicenceFee",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},
body:JSON.stringify({licenceID:A})}).then(function(a){return a.json()}).then(function(a){a.success&&(window.llm.disableNavBlocker(),window.location.reload(!0))})};document.getElementById("is-remove-licence-fee-button").addEventListener("click",function(){window.llm.confirmModal("Remove Fee Payment?","Are you sure you want to remove the fee payment and change the licence to unpaid?","Yes, Remove Payment","danger",R)})}})();
