(function(){function x(){r.getElementsByTagName("fieldset")[0].setAttribute("disabled","disabled");y=!0}function k(a){window.llm.enableNavBlocker();D.innerHTML='<div class="has-text-info"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i> Unsaved Changes</div>';r&&a&&"number"===a.currentTarget.type&&x()}function E(a){0===h.length?window.fetch("/locations/doGetLocations",{method:"GET",credentials:"include"}).then(function(a){return a.json()}).then(function(c){h=c;a()}):a()}var z=document.getElementById("form--licence"),
D=document.getElementById("container--form-message"),F=document.getElementById("licence--licenceID").value,A=""===F,r=document.getElementById("form--licenceFee"),y=!1,t=document.getElementById("container--events");z.addEventListener("submit",function(a){a.preventDefault();0===t.getElementsByTagName("input").length?window.llm.alertModal("Event Date Error","Please ensure there is at least one event date.","OK","warning"):(D.innerHTML='Saving... <i class="fas fa-circle-notch fa-spin" aria-hidden="true"></i>',
window.fetch("/licences/doSave",{method:"POST",credentials:"include",body:new URLSearchParams(new FormData(z))}).then(function(a){return a.json()}).then(function(a){a.success&&window.llm.disableNavBlocker();if(a.success&&A)window.location.href="/licences/"+a.licenceID+"/edit";else if(a.success&&y)window.location.reload(!0);else{D.innerHTML="";window.llm.alertModal(a.message,"","OK",a.success?"success":"danger");a=document.getElementsByClassName("is-removed-after-save");for(var b=0;b<a.length;b+=1)a[b].remove()}}))});
A||document.getElementById("is-delete-licence-button").addEventListener("click",function(a){a.preventDefault();window.llm.confirmModal("Delete Licence?","Are you sure you want to delete this licence and all events associated with it?","Yes, Delete","danger",function(){window.fetch("/licences/doDelete",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({licenceID:F})}).then(function(a){return a.json()}).then(function(a){a.success&&(window.llm.disableNavBlocker(),
window.location.href="/licences")})})});for(var d=z.querySelectorAll("input, select, textarea"),e=0;e<d.length;e+=1)""!==d[e].name&&d[e].addEventListener("change",k);(d=document.getElementById("is-external-licence-number-unlock-button"))&&d.addEventListener("click",function(){var a=document.getElementById("licence--externalLicenceNumber");a.classList.remove("is-readonly");a.removeAttribute("readonly");a.focus()});var B=[],N,u,G,X=function(a){a.preventDefault();a=a.currentTarget;document.getElementById("licence--organizationID").value=
a.getAttribute("data-organization-id");document.getElementById("licence--organizationName").value=a.getAttribute("data-organization-name");N();k()},H=function(){var a=document.createElement("div");a.className="list is-hoverable";for(var c=u.value.trim().toLowerCase().split(" "),b=10,e=0;e<B.length&&0<b;e+=1){var f=!0,g=B[e];if(g.isEligibleForLicences){for(var d=g.organizationName.toLowerCase(),l=0;l<c.length;l+=1)if(-1===d.indexOf(c[l])){f=!1;break}f&&(--b,f=document.createElement("a"),f.className=
"list-item",f.setAttribute("data-organization-id",g.organizationID),f.setAttribute("data-organization-name",g.organizationName),f.innerText=g.organizationName,f.addEventListener("click",X),a.insertAdjacentElement("beforeend",f))}}window.llm.clearElement(G);G.insertAdjacentElement("beforeend",a)};document.getElementById("is-organization-lookup-button").addEventListener("click",function(){window.llm.openHtmlModal("licence-organizationLookup",{onshow:function(){u=document.getElementById("organizationLookup--searchStr");
u.addEventListener("keyup",H);G=document.getElementById("container--organizationLookup");0===B.length?window.fetch("/organizations/doGetAll",{method:"GET",credentials:"include"}).then(function(a){return a.json()}).then(function(a){B=a;u.removeAttribute("disabled");H()}):(u.removeAttribute("disabled"),H())},onshown:function(a,c){N=c}})});var h=[],I,C,J,O=function(a,c){document.getElementById("licence--locationID").value=a;document.getElementById("licence--locationDisplayName").value=c},Y=function(a){a.preventDefault();
a=a.currentTarget;O(a.getAttribute("data-location-id"),a.getAttribute("data-location-display-name"));I();k()},P=function(){var a=document.createElement("div");a.className="list is-hoverable";for(var c=C.value.trim().toLowerCase().split(" "),b=10,e=0;e<h.length&&0<b;e+=1){for(var f=!0,g=h[e],d=g.locationName.toLowerCase(),l=0;l<c.length;l+=1)if(-1===d.indexOf(c[l])){f=!1;break}f&&(--b,f=""===g.locationName?g.locationAddress1:g.locationName,d=document.createElement("a"),d.className="list-item",d.setAttribute("data-location-id",
g.locationID),d.setAttribute("data-location-display-name",f),d.innerHTML=f+(""===g.locationName?"":"<br /><small>"+g.locationAddress1+"</small>"),d.addEventListener("click",Y),a.insertAdjacentElement("beforeend",d))}window.llm.clearElement(J);J.insertAdjacentElement("beforeend",a)};document.getElementById("is-location-lookup-button").addEventListener("click",function(){window.llm.openHtmlModal("licence-locationLookup",{onshow:function(a){C=document.getElementById("locationLookup--searchStr");C.addEventListener("keyup",
P);J=document.getElementById("container--locationLookup");E(function(){C.removeAttribute("disabled");P()});window.llm.getDefaultConfigProperty("city",function(a){a&&(document.getElementById("newLocation--locationCity").value=a)});window.llm.getDefaultConfigProperty("province",function(a){a&&(document.getElementById("newLocation--locationProvince").value=a)});document.getElementById("form--newLocation").addEventListener("submit",function(a){a.preventDefault();window.fetch("/locations/doCreate",{method:"POST",
credentials:"include",body:new URLSearchParams(new FormData(a.currentTarget))}).then(function(a){return a.json()}).then(function(a){a.success&&(h=[],O(a.locationID,a.locationDisplayName),I())})});window.llm.initializeTabs(a.querySelector(".tabs ul"))},onshown:function(a,c){I=c}})});var p=[],K=document.getElementById("is-termsConditions-lookup-modal"),v=document.getElementById("container--termsConditionsPrevious"),Z=function(a){a.preventDefault();a=parseInt(a.currentTarget.getAttribute("data-terms-conditions-index"));
document.getElementById("licence--termsConditions").value=p[a].termsConditions;window.llm.hideModal(K);k()};document.getElementById("is-termsConditions-lookup-button").addEventListener("click",function(){p=[];window.llm.clearElement(v);var a=document.getElementById("licence--organizationID").value;""===a?window.llm.alertModal("No Organization Selected","An organization must be selected before the previously used terms and conditions can be retrieved.","OK","warning"):(v.innerHTML='<p class="has-text-centered has-text-grey-lighter"><i class="fas fa-3x fa-circle-notch fa-spin" aria-hidden="true"></i><br />Loading previously used terms and conditions...</p>',
window.fetch("/licences/doGetDistinctTermsConditions",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({organizationID:a})}).then(function(a){return a.json()}).then(function(a){p=a;if(0===p.length)v.innerHTML='<p class="has-text-centered">No previously used terms and conditions found for this organization.</p>';else{a=document.createElement("div");a.className="list is-hoverable has-margin-bottom-10";for(var b=0;b<p.length;b+=1){var c=p[b],f=document.createElement("a");
f.className="list-item";f.setAttribute("data-terms-conditions-index",b);f.innerHTML="<p>"+window.llm.escapeHTML(c.termsConditions)+'</p><p class="has-text-right">'+(1<c.termsConditionsCount?'<span class="tag is-light">Used '+c.termsConditionsCount+" times</span>":"")+'<span class="tag is-info">'+c.startDateMaxString+"</span></p>";f.addEventListener("click",Z);a.insertAdjacentElement("beforeend",f)}window.llm.clearElement(v);v.insertAdjacentElement("beforeend",a)}}),window.llm.showModal(K))});d=K.getElementsByClassName("is-close-modal-button");
for(e=0;e<d.length;e+=1)d[e].addEventListener("click",window.llm.hideModal);var Q=document.getElementById("licence--licenceTypeKey");if(A){var q=document.getElementsByClassName("container-licenceTypeFields");Q.addEventListener("change",function(a){var c="true"===a.currentTarget.selectedOptions[0].getAttribute("data-has-ticket-types"),b=document.getElementById("licence--totalPrizeValue");c?(document.getElementById("is-ticket-types-panel").classList.remove("is-hidden"),b.setAttribute("readonly","readonly"),
b.classList.add("is-readonly")):(c=document.getElementById("is-ticket-types-panel"),c.classList.add("is-hidden"),window.llm.clearElement(c.getElementsByTagName("tbody")[0]),window.llm.clearElement(c.getElementsByTagName("tfoot")[0]),b.removeAttribute("readonly"),b.classList.remove("is-readonly"));a="container-licenceTypeFields--"+a.currentTarget.value;for(b=0;b<q.length;b+=1)q[b].id===a?(q[b].removeAttribute("disabled"),q[b].classList.remove("is-hidden")):(q[b].classList.add("is-hidden"),q[b].setAttribute("disabled",
"disabled"))})}var w=document.getElementById("licence--startDateString"),n=document.getElementById("licence--endDateString");document.getElementById("licence--applicationDateString").addEventListener("change",function(a){w.setAttribute("min",a.currentTarget.value)});w.addEventListener("change",function(){var a=w.value;n.setAttribute("min",a);n.value<a&&(n.value=a);for(var c=t.getElementsByTagName("input"),b=0;b<c.length;b+=1)c[b].setAttribute("min",a)});n.addEventListener("change",function(){for(var a=
n.value,c=t.getElementsByTagName("input"),b=0;b<c.length;b+=1)c[b].setAttribute("max",a)});var aa=function(a){a.currentTarget.closest(".panel-block").remove();y=!0;k()},R=function(a){var c="";if(a)if(a instanceof Date)c=a.getFullYear()+"-"+("00"+(a.getMonth()+1)).slice(-2)+"-"+("00"+a.getDate()).slice(-2);else if(a.constructor===String)c=a;else if(a instanceof Object)try{a.preventDefault();var b=a.currentTarget.getAttribute("data-source"),c=document.getElementById(b).value}catch(da){}t.insertAdjacentHTML("beforeend",
'<div class="panel-block is-block"><div class="field has-addons">'+('<div class="control is-expanded has-icons-left"><input class="input is-small" name="eventDate" type="date" value="'+c+'" min="'+w.value+'" max="'+n.value+'" required /><span class="icon is-left"><i class="fas fa-calendar" aria-hidden="true"></i></span></div>')+'<div class="control"><a class="button is-small is-danger has-tooltip-right" role="button" data-tooltip="Remove Event"><i class="fas fa-trash" aria-hidden="true"></i><span class="sr-only">Remove Event</span></a></div></div></div>');
a=t.getElementsByTagName("a");a[a.length-1].addEventListener("click",aa);y=!0;k()},L=document.getElementById("is-event-calculator-modal");document.getElementsByClassName("is-calculate-events-button")[0].addEventListener("click",function(){for(var a=parseInt(document.getElementById("eventCalc--eventCount").value),c=parseInt(document.getElementById("eventCalc--dayInterval").value),b=n.value.split("-"),e=new Date(b[0],parseInt(b[1])-1,b[2]),b=w.value.split("-"),b=new Date(b[0],parseInt(b[1])-1,b[2]),
f=0;f<a&&b.getTime()<=e.getTime();f+=1)R(b),b.setDate(b.getDate()+c);window.llm.hideModal(L)});document.getElementById("is-event-calculator-button").addEventListener("click",function(){window.llm.showModal(L)});d=L.getElementsByClassName("is-close-modal-button");for(e=0;e<d.length;e+=1)d[e].addEventListener("click",window.llm.hideModal);d=document.getElementsByClassName("is-add-event-button");for(e=0;e<d.length;e+=1)d[e].addEventListener("click",R);var m=document.getElementById("is-ticket-types-panel");
if(m){var M={},S=function(){for(var a=0,c=m.getElementsByClassName("is-prizes-per-deal"),b=0;b<c.length;b+=1)a+=parseFloat(c[b].value);for(var c=0,b=m.getElementsByClassName("is-licence-fee"),e=0;e<b.length;e+=1)c+=parseFloat(b[e].value);m.getElementsByTagName("tfoot")[0].innerHTML='<tr><td></td><td></td><td></td><th class="has-text-right">$ '+a.toFixed(2)+'</th><td></td><th class="has-text-right">$ '+c.toFixed(2)+"</th><td></td><td></td><td></td><td></td></tr>";document.getElementById("licence--totalPrizeValue").value=
a;k();x()},T=function(a){var c=a.currentTarget.closest("tr"),b=c.getAttribute("data-ticket-type");window.llm.confirmModal("Delete Ticket Type?","Are you sure you want to remove the "+b+" ticket type for this licence?","Yes, Delete","danger",function(){c.remove();z.insertAdjacentHTML("beforeend",'<input class="is-removed-after-save" name="ticketType_toDelete" type="hidden" value="'+b+'" />');S();k();x()})},U=function(a){},V=function(a){var c,b=a.currentTarget.closest("td").previousElementSibling,e=
function(a){b.getElementsByTagName("input")[0].value=a.currentTarget.getAttribute("data-location-id");b.getElementsByTagName("span")[0].innerText=a.currentTarget.getAttribute("data-location-display-name");c();k()};window.llm.openHtmlModal("licence-distributorLookup",{onshow:function(){E(function(){var a=document.createElement("div");a.className="list is-hoverable";for(var b=0;b<h.length;b+=1){var c=h[b];if(c.locationIsDistributor){var d=document.createElement("a");d.className="list-item";d.setAttribute("data-location-id",
c.locationID);d.setAttribute("data-location-display-name",c.locationDisplayName);d.innerText=c.locationDisplayName;d.addEventListener("click",e);a.insertAdjacentElement("beforeend",d)}}b=document.getElementById("container--distributorLookup");window.llm.clearElement(b);b.insertAdjacentElement("beforeend",a)})},onshown:function(a,b){c=b}})},W=function(a){var c,b=a.currentTarget.closest("td").previousElementSibling,e=function(a){b.getElementsByTagName("input")[0].value=a.currentTarget.getAttribute("data-location-id");
b.getElementsByTagName("span")[0].innerText=a.currentTarget.getAttribute("data-location-display-name");c();k()};window.llm.openHtmlModal("licence-manufacturerLookup",{onshow:function(){E(function(){var a=document.createElement("div");a.className="list is-hoverable";for(var b=0;b<h.length;b+=1){var c=h[b];if(c.locationIsManufacturer){var d=document.createElement("a");d.className="list-item";d.setAttribute("data-location-id",c.locationID);d.setAttribute("data-location-display-name",c.locationDisplayName);
d.innerText=c.locationDisplayName;d.addEventListener("click",e);a.insertAdjacentElement("beforeend",d)}}b=document.getElementById("container--manufacturerLookup");window.llm.clearElement(b);b.insertAdjacentElement("beforeend",a)})},onshown:function(a,b){c=b}})};document.getElementById("is-add-ticket-type-button").addEventListener("click",function(){var a,c,b,d=Q.value,e=function(b){b.preventDefault();var c=document.getElementById("ticketTypeAdd--ticketType").value;b=document.createElement("tr");b.setAttribute("data-ticket-type",
c);b.insertAdjacentHTML("beforeend",'<td><input name="ticketType_ticketType" type="hidden" value="'+c+'" /><span>'+c+"</span></td>");c=document.getElementById("ticketTypeAdd--unitCount").value;b.insertAdjacentHTML("beforeend",'<td class="has-text-right"><input name="ticketType_unitCount" type="hidden" value="'+c+'" /><span>'+c+"</span></td>");var d=document.getElementById("ticketTypeAdd--valuePerDeal").value,e=(d*c).toFixed(2);b.insertAdjacentHTML("beforeend",'<td class="has-text-right"><span data-tooltip="$'+
d+' value per deal">$ '+e+"</span></td>");d=document.getElementById("ticketTypeAdd--prizesPerDeal").value;c=(d*c).toFixed(2);b.insertAdjacentHTML("beforeend",'<td class="has-text-right"><input class="is-prizes-per-deal" type="hidden" value="'+c+'" /><span data-tooltip="$'+d+' prizes per deal">$ '+c+"</span></td>");b.insertAdjacentHTML("beforeend",'<td><div class="field has-addons"><div class="control"><button class="button is-small is-amend-ticket-type-unit-count-button" data-tooltip="Amend Units" type="button">Amend</button></div><div class="control"><button class="button is-small is-danger is-delete-ticket-type-button" data-tooltip="Delete Ticket Type" type="button"><i class="fas fa-trash" aria-hidden="true"></i><span class="sr-only">Delete</span></button></div></div></td>');
b.getElementsByClassName("is-amend-ticket-type-unit-count-button")[0].addEventListener("click",U);b.getElementsByClassName("is-delete-ticket-type-button")[0].addEventListener("click",T);c=document.getElementById("ticketTypeAdd--licenceFee").value;b.insertAdjacentHTML("beforeend",'<td class="has-text-right"><input class="is-licence-fee" name="ticketType_licenceFee" type="hidden" value="'+c+'" /><span>$ '+c+"</span></td>");b.insertAdjacentHTML("beforeend",'<td><input name="ticketType_distributorLocationID" type="hidden" value="" /><span><span class="has-text-grey">(Not Set)</span><span></td>');
b.insertAdjacentHTML("beforeend",'<td class="has-text-right"><button class="button is-small is-amend-ticket-type-distributor-button" type="button">Change</button></td>');b.getElementsByClassName("is-amend-ticket-type-distributor-button")[0].addEventListener("click",V);b.insertAdjacentHTML("beforeend",'<td><input name="ticketType_manufacturerLocationID" type="hidden" value="" /><span><span class="has-text-grey">(Not Set)</span><span></td>');b.insertAdjacentHTML("beforeend",'<td class="has-text-right"><button class="button is-small is-amend-ticket-type-manufacturer-button" type="button">Change</button></td>');
b.getElementsByClassName("is-amend-ticket-type-manufacturer-button")[0].addEventListener("click",W);m.getElementsByTagName("tbody")[0].insertAdjacentElement("afterbegin",b);a();S();k();x()},g=function(){var a=b.value;document.getElementById("ticketTypeAdd--prizesTotal").value=(document.getElementById("ticketTypeAdd--prizesPerDeal").value*a).toFixed(2);document.getElementById("ticketTypeAdd--licenceFee").value=(document.getElementById("ticketTypeAdd--feePerUnit").value*a).toFixed(2)},h=function(){var a=
c.selectedOptions[0];document.getElementById("ticketTypeAdd--ticketPrice").value=a.getAttribute("data-ticket-price");document.getElementById("ticketTypeAdd--ticketCount").value=a.getAttribute("data-ticket-count");document.getElementById("ticketTypeAdd--valuePerDeal").value=(a.getAttribute("data-ticket-price")*a.getAttribute("data-ticket-count")).toFixed(2);document.getElementById("ticketTypeAdd--prizesPerDeal").value=a.getAttribute("data-prizes-per-deal");document.getElementById("ticketTypeAdd--feePerUnit").value=
a.getAttribute("data-fee-per-unit");g()},l=function(){var b=M[d];if(b&&0!==b.length){for(var e=0;e<b.length;e+=1){var f=b[e];if(!m.querySelector("tr[data-ticket-type='"+f.ticketType+"']")){var g=document.createElement("option");g.setAttribute("data-ticket-price",f.ticketPrice.toFixed(2));g.setAttribute("data-ticket-count",f.ticketCount);g.setAttribute("data-prizes-per-deal",f.prizesPerDeal.toFixed(2));g.setAttribute("data-fee-per-unit",(f.feePerUnit||0).toFixed(2));g.value=f.ticketType;g.innerText=
f.ticketType;c.insertAdjacentElement("beforeend",g)}}h()}else a(),window.llm.alertModal("No ticket types available","","OK","danger")};window.llm.openHtmlModal("licence-ticketTypeAdd",{onshow:function(a){c=document.getElementById("ticketTypeAdd--ticketType");c.addEventListener("change",h);b=document.getElementById("ticketTypeAdd--unitCount");b.addEventListener("change",g);a.getElementsByTagName("form")[0].addEventListener("submit",e)},onshown:function(b,c){a=c;d in M?l():window.fetch("/licences/doGetTicketTypes",
{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({licenceTypeKey:d})}).then(function(a){return a.json()}).then(function(a){M[d]=a;l()})}})});d=m.getElementsByClassName("is-amend-ticket-type-unit-count-button");for(e=0;e<d.length;e+=1)d[e].addEventListener("click",U);d=m.getElementsByClassName("is-delete-ticket-type-button");for(e=0;e<d.length;e+=1)d[e].addEventListener("click",T);d=m.getElementsByClassName("is-amend-ticket-type-distributor-button");
for(e=0;e<d.length;e+=1)d[e].addEventListener("click",V);d=m.getElementsByClassName("is-amend-ticket-type-manufacturer-button");for(e=0;e<d.length;e+=1)d[e].addEventListener("click",W)}if(!A)if(r){var ba=function(){window.fetch("/licences/doMarkLicenceFeePaid",{method:"POST",credentials:"include",body:new URLSearchParams(new FormData(r))}).then(function(a){return a.json()}).then(function(a){a.success&&(window.llm.disableNavBlocker(),window.location.reload(!0))})};r.addEventListener("submit",function(a){a.preventDefault();
window.llm.confirmModal("Mark Fee as Paid?","Are you sure you want to mark the licence fee as paid?","Yes, Paid","info",ba)})}else{var ca=function(){window.fetch("/licences/doRemoveLicenceFee",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({licenceID:F})}).then(function(a){return a.json()}).then(function(a){a.success&&(window.llm.disableNavBlocker(),window.location.reload(!0))})};document.getElementById("is-remove-licence-fee-button").addEventListener("click",
function(){window.llm.confirmModal("Remove Fee Payment?","Are you sure you want to remove the fee payment and change the licence to unpaid?","Yes, Remove Payment","danger",ca)})}})();
