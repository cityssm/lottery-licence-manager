(function(){function g(a){window.llm.enableNavBlocker();y.innerHTML='<div class="has-text-info"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i> Unsaved Changes</div>';l&&a&&"number"===a.currentTarget.type&&(l.getElementsByTagName("fieldset")[0].setAttribute("disabled","disabled"),v=!0)}var z=document.getElementById("form--licence"),y=document.getElementById("container--form-message"),A=document.getElementById("licence--licenceID").value,w=""===A,l=document.getElementById("form--licenceFee"),
v=!1,m=document.getElementById("container--events");z.addEventListener("submit",function(a){a.preventDefault();0===m.getElementsByTagName("input").length?window.llm.alertModal("Event Date Error","Please ensure there is at least one event date.","OK","warning"):(y.innerHTML='Saving... <i class="fas fa-circle-notch fa-spin" aria-hidden="true"></i>',window.fetch("/licences/doSave",{method:"POST",credentials:"include",body:new URLSearchParams(new FormData(z))}).then(function(a){return a.json()}).then(function(a){a.success&&
window.llm.disableNavBlocker();a.success&&w?window.location.href="/licences/"+a.licenceID+"/edit":a.success&&v?window.location.reload(!0):(y.innerHTML="",window.llm.alertModal(a.message,"","OK",a.success?"success":"danger"))}))});w||document.getElementById("is-delete-licence-button").addEventListener("click",function(a){a.preventDefault();window.llm.confirmModal("Delete Licence?","Are you sure you want to delete this licence and all events associated with it?","Yes, Delete","danger",function(){window.fetch("/licences/doDelete",
{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({licenceID:A})}).then(function(a){return a.json()}).then(function(a){a.success&&(window.llm.disableNavBlocker(),window.location.href="/licences")})})});for(var c=z.querySelectorAll("input, select, textarea"),b=0;b<c.length;b+=1)""!==c[b].name&&c[b].addEventListener("change",g);(c=document.getElementById("is-external-licence-number-unlock-button"))&&c.addEventListener("click",function(){var a=document.getElementById("licence--externalLicenceNumber");
a.classList.remove("has-background-light");a.classList.remove("has-cursor-not-allowed");a.removeAttribute("readonly");a.focus()});var x=[],I,n,B,M=function(a){a.preventDefault();a=a.currentTarget;document.getElementById("licence--organizationID").value=a.getAttribute("data-organization-id");document.getElementById("licence--organizationName").value=a.getAttribute("data-organization-name");I();g()},C=function(){var a=document.createElement("div");a.className="list is-hoverable";for(var d=n.value.trim().toLowerCase().split(" "),
p=10,b=0;b<x.length&&0<p;b+=1){var f=!0,c=x[b];if(c.isEligibleForLicences){for(var N=c.organizationName.toLowerCase(),e=0;e<d.length;e+=1)if(-1===N.indexOf(d[e])){f=!1;break}f&&(--p,f=document.createElement("a"),f.className="list-item",f.setAttribute("data-organization-id",c.organizationID),f.setAttribute("data-organization-name",c.organizationName),f.innerText=c.organizationName,f.addEventListener("click",M),a.insertAdjacentElement("beforeend",f))}}window.llm.clearElement(B);B.insertAdjacentElement("beforeend",
a)};document.getElementById("is-organization-lookup-button").addEventListener("click",function(){window.llm.openHtmlModal("licence-organizationLookup",{onshow:function(){n=document.getElementById("organizationLookup--searchStr");n.addEventListener("keyup",C);B=document.getElementById("container--organizationLookup");0===x.length?window.fetch("/organizations/doGetAll",{method:"GET",credentials:"include"}).then(function(a){return a.json()}).then(function(a){x=a;n.removeAttribute("disabled");C()}):(n.removeAttribute("disabled"),
C())},onshown:function(a,d){I=d}})});var q=[],D,r,E,J=function(a,d){document.getElementById("licence--locationID").value=a;document.getElementById("licence--locationDisplayName").value=d},O=function(a){a.preventDefault();a=a.currentTarget;J(a.getAttribute("data-location-id"),a.getAttribute("data-location-display-name"));D();g()},F=function(){var a=document.createElement("div");a.className="list is-hoverable";for(var d=r.value.trim().toLowerCase().split(" "),p=10,c=0;c<q.length&&0<p;c+=1){for(var f=
!0,b=q[c],e=b.locationName.toLowerCase(),g=0;g<d.length;g+=1)if(-1===e.indexOf(d[g])){f=!1;break}f&&(--p,f=""===b.locationName?b.locationAddress1:b.locationName,e=document.createElement("a"),e.className="list-item",e.setAttribute("data-location-id",b.locationID),e.setAttribute("data-location-display-name",f),e.innerHTML=f+(""===b.locationName?"":"<br /><small>"+b.locationAddress1+"</small>"),e.addEventListener("click",O),a.insertAdjacentElement("beforeend",e))}window.llm.clearElement(E);E.insertAdjacentElement("beforeend",
a)};document.getElementById("is-location-lookup-button").addEventListener("click",function(){window.llm.openHtmlModal("licence-locationLookup",{onshow:function(a){r=document.getElementById("locationLookup--searchStr");r.addEventListener("keyup",F);E=document.getElementById("container--locationLookup");0===q.length?window.fetch("/locations/doGetLocations",{method:"GET",credentials:"include"}).then(function(a){return a.json()}).then(function(a){q=a;r.removeAttribute("disabled");F()}):(r.removeAttribute("disabled"),
F());window.llm.getDefaultConfigProperty("city",function(a){a&&(document.getElementById("newLocation--locationCity").value=a)});window.llm.getDefaultConfigProperty("province",function(a){a&&(document.getElementById("newLocation--locationProvince").value=a)});document.getElementById("form--newLocation").addEventListener("submit",function(a){a.preventDefault();window.fetch("/locations/doCreate",{method:"POST",credentials:"include",body:new URLSearchParams(new FormData(a.currentTarget))}).then(function(a){return a.json()}).then(function(a){a.success&&
(q=[],J(a.locationID,a.locationDisplayName),D())})});window.llm.initializeTabs(a.querySelector(".tabs ul"))},onshown:function(a,d){D=d}})});var h=[],G=document.getElementById("is-termsConditions-lookup-modal"),t=document.getElementById("container--termsConditionsPrevious"),P=function(a){a.preventDefault();a=parseInt(a.currentTarget.getAttribute("data-terms-conditions-index"));document.getElementById("licence--termsConditions").value=h[a].termsConditions;window.llm.hideModal(G);g()};document.getElementById("is-termsConditions-lookup-button").addEventListener("click",
function(){h=[];window.llm.clearElement(t);var a=document.getElementById("licence--organizationID").value;""===a?window.llm.alertModal("No Organization Selected","An organization must be selected before the previously used terms and conditions can be retrieved.","OK","warning"):(t.innerHTML='<p class="has-text-centered has-text-grey-lighter"><i class="fas fa-3x fa-circle-notch fa-spin" aria-hidden="true"></i><br />Loading previously used terms and conditions...</p>',window.fetch("/licences/doGetDistinctTermsConditions",
{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({organizationID:a})}).then(function(a){return a.json()}).then(function(a){h=a;if(0===h.length)t.innerHTML='<p class="has-text-centered">No previously used terms and conditions found for this organization.</p>';else{a=document.createElement("div");a.className="list is-hoverable has-margin-bottom-10";for(var d=0;d<h.length;d+=1){var b=h[d],c=document.createElement("a");c.className="list-item";c.setAttribute("data-terms-conditions-index",
d);c.innerHTML="<p>"+window.llm.escapeHTML(b.termsConditions)+'</p><p class="has-text-right">'+(1<b.termsConditionsCount?'<span class="tag is-light">Used '+b.termsConditionsCount+" times</span>":"")+'<span class="tag is-info">'+b.startDateMaxString+"</span></p>";c.addEventListener("click",P);a.insertAdjacentElement("beforeend",c)}window.llm.clearElement(t);t.insertAdjacentElement("beforeend",a)}}),window.llm.showModal(G))});c=G.getElementsByClassName("is-close-modal-button");for(b=0;b<c.length;b+=
1)c[b].addEventListener("click",window.llm.hideModal);var K=document.getElementById("licence--licenceTypeKey");if(w){var k=document.getElementsByClassName("container-licenceTypeFields");K.addEventListener("change",function(a){"true"===a.currentTarget.selectedOptions[0].getAttribute("data-has-ticket-types")?document.getElementById("is-ticket-types-panel").classList.remove("is-hidden"):document.getElementById("is-ticket-types-panel").classList.add("is-hidden");a="container-licenceTypeFields--"+a.currentTarget.value;
for(var d=0;d<k.length;d+=1)k[d].id===a?(k[d].removeAttribute("disabled"),k[d].classList.remove("is-hidden")):(k[d].classList.add("is-hidden"),k[d].setAttribute("disabled","disabled"))})}var u=document.getElementById("licence--startDateString"),e=document.getElementById("licence--endDateString");document.getElementById("licence--applicationDateString").addEventListener("change",function(a){u.setAttribute("min",a.currentTarget.value)});u.addEventListener("change",function(){var a=u.value;e.setAttribute("min",
a);e.value<a&&(e.value=a);for(var d=m.getElementsByTagName("input"),b=0;b<d.length;b+=1)d[b].setAttribute("min",a)});e.addEventListener("change",function(){for(var a=e.value,d=m.getElementsByTagName("input"),b=0;b<d.length;b+=1)d[b].setAttribute("max",a)});var Q=function(a){a.currentTarget.closest(".panel-block").remove();v=!0;g()},L=function(a){var b="";if(a)if(a instanceof Date)b=a.getFullYear()+"-"+("00"+(a.getMonth()+1)).slice(-2)+"-"+("00"+a.getDate()).slice(-2);else if(a.constructor===String)b=
a;else if(a instanceof Object)try{a.preventDefault();var c=a.currentTarget.getAttribute("data-source"),b=document.getElementById(c).value}catch(T){}m.insertAdjacentHTML("beforeend",'<div class="panel-block is-block"><div class="field has-addons">'+('<div class="control is-expanded has-icons-left"><input class="input is-small" name="eventDate" type="date" value="'+b+'" min="'+u.value+'" max="'+e.value+'" required /><span class="icon is-left"><i class="fas fa-calendar" aria-hidden="true"></i></span></div>')+
'<div class="control"><a class="button is-small is-danger has-tooltip-right" role="button" data-tooltip="Remove Event"><i class="fas fa-trash" aria-hidden="true"></i><span class="sr-only">Remove Event</span></a></div></div></div>');a=m.getElementsByTagName("a");a[a.length-1].addEventListener("click",Q);v=!0;g()},H=document.getElementById("is-event-calculator-modal");document.getElementsByClassName("is-calculate-events-button")[0].addEventListener("click",function(){for(var a=parseInt(document.getElementById("eventCalc--eventCount").value),
b=parseInt(document.getElementById("eventCalc--dayInterval").value),c=e.value.split("-"),g=new Date(c[0],parseInt(c[1])-1,c[2]),c=u.value.split("-"),c=new Date(c[0],parseInt(c[1])-1,c[2]),f=0;f<a&&c.getTime()<=g.getTime();f+=1)L(c),c.setDate(c.getDate()+b);window.llm.hideModal(H)});document.getElementById("is-event-calculator-button").addEventListener("click",function(){window.llm.showModal(H)});c=H.getElementsByClassName("is-close-modal-button");for(b=0;b<c.length;b+=1)c[b].addEventListener("click",
window.llm.hideModal);c=document.getElementsByClassName("is-add-event-button");for(b=0;b<c.length;b+=1)c[b].addEventListener("click",L);document.getElementById("is-ticket-types-panel")&&document.getElementById("is-add-ticket-type-button").addEventListener("click",function(){window.llm.openHtmlModal("licence-ticketTypeAdd",{onshow:function(a){window.fetch("/licences/doGetTicketTypes",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({licenceTypeKey:K.value})}).then(function(a){return a.json()}).then(function(a){})}})});
if(!w)if(l){var R=function(){window.fetch("/licences/doMarkLicenceFeePaid",{method:"POST",credentials:"include",body:new URLSearchParams(new FormData(l))}).then(function(a){return a.json()}).then(function(a){a.success&&(window.llm.disableNavBlocker(),window.location.reload(!0))})};l.addEventListener("submit",function(a){a.preventDefault();window.llm.confirmModal("Mark Fee as Paid?","Are you sure you want to mark the licence fee as paid?","Yes, Paid","info",R)})}else{var S=function(){window.fetch("/licences/doRemoveLicenceFee",
{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({licenceID:A})}).then(function(a){return a.json()}).then(function(a){a.success&&(window.llm.disableNavBlocker(),window.location.reload(!0))})};document.getElementById("is-remove-licence-fee-button").addEventListener("click",function(){window.llm.confirmModal("Remove Fee Payment?","Are you sure you want to remove the fee payment and change the licence to unpaid?","Yes, Remove Payment","danger",S)})}})();
