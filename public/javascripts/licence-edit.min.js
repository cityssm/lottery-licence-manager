"use strict";if(Object.defineProperty(exports,"__esModule",{value:!0}),llm.licenceEdit={},(()=>{const e=document.querySelector("main").dataset.urlPrefix,t=document.querySelector("#form--licence"),n=document.querySelector("#container--form-message"),a=document.querySelector("#licence--licenceID").value,o=""===a,i="true"===t.getAttribute("data-licence-is-issued"),c=new Set(["number","date","time"]);let s=!1,r=!1;const l=document.querySelector("#container--events");t.addEventListener("submit",a=>{a.preventDefault(),0!==l.querySelectorAll("input").length?(n.innerHTML='Saving... <i class="fas fa-circle-notch fa-spin" aria-hidden="true"></i>',cityssm.postJSON(e+"/licences/doSave",t,t=>{if(t.success&&(cityssm.disableNavBlocker(),r=!1),t.success&&o)window.location.href=e+"/licences/"+t.licenceID.toString()+"/edit";else if(t.success&&s)window.location.reload();else{n.innerHTML="",cityssm.alertModal(t.message,"","OK",t.success?"success":"danger");const e=document.querySelectorAll(".is-removed-after-save");for(const t of e)t.remove()}})):cityssm.alertModal("Event Date Error","Please ensure there is at least one event date.","OK","warning")}),o||document.querySelector("#is-delete-licence-button").addEventListener("click",t=>{t.preventDefault();cityssm.confirmModal("Delete Licence?","Are you sure you want to delete this licence and all events associated with it?","Yes, Delete","danger",()=>{cityssm.postJSON(e+"/licences/doDelete",{licenceID:a},t=>{t.success&&(cityssm.disableNavBlocker(),window.location.href=e+"/licences")})})}),llm.licenceEdit.setDoRefreshAfterSaveFunction=(()=>{s=!0}),llm.licenceEdit.setUnsavedChangesFunction=(e=>{if(cityssm.enableNavBlocker(),r=!0,n.innerHTML='<span class="tag is-light is-info is-medium"><span class="icon"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i></span> <span>Unsaved Changes</span></div>',o||(document.querySelector("#is-add-transaction-button").setAttribute("disabled","disabled"),document.querySelector("#is-disabled-transaction-message").classList.remove("is-hidden")),e){const t=e.currentTarget instanceof HTMLInputElement?e.currentTarget.type:"";c.has(t)&&llm.licenceEdit.setDoRefreshAfterSaveFunction()}});const d=t.querySelectorAll("input, select, textarea");for(const e of d)""!==e.name&&e.addEventListener("change",llm.licenceEdit.setUnsavedChangesFunction);const u=document.querySelector("#is-external-licence-number-unlock-button");u&&u.addEventListener("click",()=>{const e=document.querySelector("#licence--externalLicenceNumber");e.classList.remove("is-readonly"),e.removeAttribute("readonly"),e.focus()});{let t,n,a,o=[];const i=e=>{e.preventDefault();const n=e.currentTarget;document.querySelector("#licence--organizationID").value=n.getAttribute("data-organization-id"),document.querySelector("#licence--organizationName").value=n.getAttribute("data-organization-name"),t(),llm.licenceEdit.setUnsavedChangesFunction()},c=()=>{const e=document.createElement("div");e.className="panel";const t=n.value.trim().toLowerCase().split(" ");let c=10;for(const n of o){if(c<0)break;let a=!0;if(!n.isEligibleForLicences)continue;const o=n.organizationName.toLowerCase();for(const e of t)if(!o.includes(e)){a=!1;break}if(a){c-=1;const t=document.createElement("a");t.className="panel-block is-block",t.dataset.organizationId=n.organizationID.toString(),t.dataset.organizationName=n.organizationName,t.setAttribute("href","#"),t.innerHTML=cityssm.escapeHTML(n.organizationName)+'<br /><span class="is-size-7"><span class="icon"><i class="fas fa-user" aria-hidden="true"></i></span> '+(n.representativeName?cityssm.escapeHTML(n.representativeName):'<span class="has-text-grey">(No Representative)</span>')+"</span>",t.addEventListener("click",i),e.append(t)}}cityssm.clearElement(a),a.append(e)},s=()=>{cityssm.openHtmlModal("licence-organizationLookup",{onshow(){(n=document.querySelector("#organizationLookup--searchStr")).addEventListener("keyup",c),a=document.querySelector("#container--organizationLookup"),0===o.length?cityssm.postJSON(e+"/organizations/doGetAll",void 0,e=>{o=e,n.removeAttribute("disabled"),c(),n.focus()}):(n.removeAttribute("disabled"),c(),n.focus())},onshown(e,a){t=a,n.focus()},onremoved(){document.querySelector("#is-organization-lookup-button").focus()}})};document.querySelector("#is-organization-lookup-button").addEventListener("click",s),document.querySelector("#licence--organizationName").addEventListener("dblclick",s)}let m=[];llm.licenceEdit.loadLocationListFunction=(t=>{0===m.length?cityssm.postJSON(e+"/locations/doGetLocations",{},e=>{m=e.locations,t(m)}):t(m)});{let t,n,a;const o=(e,t)=>{document.querySelector("#licence--locationID").value=e.toString(),document.querySelector("#licence--locationDisplayName").value=t},i=e=>{e.preventDefault();const n=e.currentTarget;o(Number.parseInt(n.getAttribute("data-location-id"),10),n.getAttribute("data-location-display-name")),t(),llm.licenceEdit.setUnsavedChangesFunction()},c=()=>{const e=document.createElement("div");e.className="panel";const t=n.value.trim().toLowerCase().split(" ");let o=10;for(const n of m){if(o<=0)break;let a=!0;const c=n.locationName.toLowerCase();for(const e of t)if(!c.includes(e)){a=!1;break}if(a){o-=1;const t=document.createElement("a");t.className="panel-block is-block",t.dataset.locationId=n.locationID.toString(),t.dataset.locationDisplayName=n.locationDisplayName,t.setAttribute("href","#"),t.innerHTML='<div class="columns"><div class="column is-narrow"><i class="fas fa-map-marker-alt" aria-hidden="true"></i></div><div class="column">'+cityssm.escapeHTML(n.locationDisplayName)+"</div>"+(""===n.locationName?"":'<div class="column">'+cityssm.escapeHTML(n.locationAddress1)+"</div>")+"</div>",t.addEventListener("click",i),e.append(t)}}cityssm.clearElement(a),a.append(e)},s=()=>{cityssm.openHtmlModal("licence-locationLookup",{onshow(i){(n=document.querySelector("#locationLookup--searchStr")).addEventListener("keyup",c),a=document.querySelector("#container--locationLookup"),llm.licenceEdit.loadLocationListFunction(()=>{n.removeAttribute("disabled"),c(),n.focus()}),llm.getDefaultConfigProperty("city",e=>{e&&(document.querySelector("#newLocation--locationCity").value=e)}),llm.getDefaultConfigProperty("province",e=>{e&&(document.querySelector("#newLocation--locationProvince").value=e)}),document.querySelector("#form--newLocation").addEventListener("submit",n=>{n.preventDefault(),cityssm.postJSON(e+"/locations/doCreate",n.currentTarget,e=>{e.success&&(m=[],o(e.locationID,e.locationDisplayName),t())})}),llm.initializeTabs(i.querySelector(".tabs ul"))},onshown(e,a){t=a,n.focus()},onremoved(){document.querySelector("#is-location-lookup-button").focus()}})};document.querySelector("#is-location-lookup-button").addEventListener("click",s),document.querySelector("#licence--locationDisplayName").addEventListener("dblclick",s)}document.querySelector("#is-endDateString-year-button").addEventListener("click",()=>{const e=document.querySelector("#licence--endDateString"),t=e.valueAsDate;t.setFullYear(t.getFullYear()+1),e.valueAsDate=t,llm.licenceEdit.setUnsavedChangesFunction(),llm.licenceEdit.setDoRefreshAfterSaveFunction()});{let t=[];const n=document.querySelector("#is-termsConditions-lookup-modal"),a=document.querySelector("#container--termsConditionsPrevious"),o=e=>{e.preventDefault();const a=Number.parseInt(e.currentTarget.getAttribute("data-terms-conditions-index"),10),o=document.querySelector("#licence--termsConditions");o.value=t[a].termsConditions,cityssm.hideModal(n),o.focus(),llm.licenceEdit.setUnsavedChangesFunction()};document.querySelector("#is-termsConditions-lookup-button").addEventListener("click",()=>{t=[],cityssm.clearElement(a);const i=document.querySelector("#licence--organizationID").value;""!==i?(a.innerHTML='<p class="has-text-centered has-text-grey-lighter"><i class="fas fa-3x fa-circle-notch fa-spin" aria-hidden="true"></i><br />Loading previously used terms and conditions...</p>',cityssm.postJSON(e+"/licences/doGetDistinctTermsConditions",{organizationID:i},e=>{if(0===(t=e).length)a.innerHTML='<p class="has-text-centered">No previously used terms and conditions found for this organization.</p>';else{const e=document.createElement("div");e.className="panel mb-3";for(const[n,a]of t.entries()){const t=document.createElement("a");t.className="panel-block is-block",t.dataset.termsConditionsIndex=n.toString(),t.innerHTML='<p class="has-newline-chars">'+cityssm.escapeHTML(a.termsConditions)+'</p><p class="has-text-right">'+(a.termsConditionsCount>1?'<span class="tag is-light has-tooltip-left" data-tooltip="Included on Multiple Licences"><span class="icon"><i class="fas fa-star" aria-hidden="true"></i></span> <span>Used '+a.termsConditionsCount.toString()+" times</span></span>":"")+(a.isIssued>=1?'<span class="tag is-info has-tooltip-left" data-tooltip="Included on an Issued Licence"><span class="icon"><i class="fas fa-stamp" aria-hidden="true"></i></span> <span>Issued</span></span>':"")+' <span class="tag is-info has-tooltip-left" data-tooltip="Most Recent Licence Start Date"><span class="icon"><i class="fas fa-calendar" aria-hidden="true"></i></span> <span>'+a.startDateMaxString+"</span></span></p>",t.addEventListener("click",o),e.append(t)}cityssm.clearElement(a),a.append(e)}}),cityssm.showModal(n)):cityssm.alertModal("No Organization Selected","An organization must be selected before the previously used terms and conditions can be retrieved.","OK","warning")});const i=n.querySelectorAll(".is-close-modal-button");for(const e of i)e.addEventListener("click",cityssm.hideModal)}const p=document.querySelector("#licence--licenceTypeKey");if(o){const e=document.querySelectorAll(".container-licenceTypeFields"),t=()=>{const t=p.selectedOptions[0],n=t.dataset.totalPrizeValueMax;document.querySelector("#licence--totalPrizeValue").setAttribute("max",n);const a="true"===t.dataset.hasTicketTypes,o=document.querySelector("#licence--totalPrizeValue");if(a)document.querySelector("#is-ticket-types-panel").classList.remove("is-hidden"),o.setAttribute("readonly","readonly"),o.classList.add("is-readonly");else{const e=document.querySelector("#is-ticket-types-panel");e.classList.add("is-hidden"),cityssm.clearElement(e.querySelector("tbody")),cityssm.clearElement(e.querySelector("tfoot")),o.removeAttribute("readonly"),o.classList.remove("is-readonly")}const i="container-licenceTypeFields--"+p.value;for(const t of e)t.id===i?(t.removeAttribute("disabled"),t.classList.remove("is-hidden")):(t.classList.add("is-hidden"),t.setAttribute("disabled","disabled"))};p.addEventListener("change",t)}{const e=document.querySelector("#licence--startDateString"),t=document.querySelector("#licence--endDateString"),n=()=>{const n=e.value;t.setAttribute("min",n),t.value<n&&(t.value=n);const a=l.querySelectorAll("input");for(const e of a)e.setAttribute("min",n)},a=()=>{const e=t.value,n=l.querySelectorAll("input");for(const t of n)t.setAttribute("max",e)};document.querySelector("#licence--applicationDateString").addEventListener("change",t=>{e.setAttribute("min",t.currentTarget.value)}),e.addEventListener("change",n),t.addEventListener("change",a);const o=e=>{e.currentTarget.closest(".panel-block").remove(),s=!0,llm.licenceEdit.setUnsavedChangesFunction()},i=n=>{let a="";if(n)if(n instanceof Date)a=n.getFullYear().toString()+"-"+("00"+(n.getMonth()+1).toString()).slice(-2)+"-"+("00"+n.getDate().toString()).slice(-2);else if(n.constructor===String)a=n;else if(n instanceof Event)try{n.preventDefault();const e=n.currentTarget.dataset.source;a=document.querySelector("#"+e).value}catch(e){}l.insertAdjacentHTML("beforeend",'<div class="panel-block is-block"><div class="field has-addons"><div class="control is-expanded has-icons-left"><input class="input is-small input--eventDateString" name="eventDateString" type="date" value="'+cityssm.escapeHTML(a)+'" min="'+cityssm.escapeHTML(e.value)+'" max="'+cityssm.escapeHTML(t.value)+'" required /><span class="icon is-left"><i class="fas fa-calendar" aria-hidden="true"></i></span></div><div class="control"><a class="button is-small is-danger has-tooltip-right" role="button" data-tooltip="Remove Event"><i class="fas fa-trash" aria-hidden="true"></i><span class="sr-only">Remove Event</span></a></div></div></div>');const i=l.querySelectorAll("a");i[i.length-1].addEventListener("click",o),s=!0,llm.licenceEdit.setUnsavedChangesFunction()},c=document.querySelector("#is-event-calculator-modal");document.querySelectorAll(".is-calculate-events-button")[0].addEventListener("click",()=>{const n=Number.parseInt(document.querySelector("#eventCalc--eventCount").value,10),a=Number.parseInt(document.querySelector("#eventCalc--dayInterval").value,10);let o=t.value.split("-");const s=new Date(Number.parseInt(o[0],10),Number.parseInt(o[1],10)-1,Number.parseInt(o[2],10));o=e.value.split("-");const r=new Date(Number.parseInt(o[0],10),Number.parseInt(o[1],10)-1,Number.parseInt(o[2],10));for(let e=0;e<n&&r.getTime()<=s.getTime();e+=1)i(r),r.setDate(r.getDate()+a);cityssm.hideModal(c)}),document.querySelector("#is-event-calculator-button").addEventListener("click",()=>{cityssm.showModal(c)});const r=c.querySelectorAll(".is-close-modal-button");for(const e of r)e.addEventListener("click",cityssm.hideModal);const d=document.querySelectorAll(".is-add-event-button");for(const e of d)e.addEventListener("click",i)}if(!o){const t=document.querySelector("#is-update-expected-licence-fee-button");t&&t.addEventListener("click",()=>{const e=document.querySelector("#licence--licenceFee");e.value=t.getAttribute("data-licence-fee-expected"),e.classList.remove("is-danger"),e.closest(".field").querySelector(".help").remove(),t.remove(),llm.licenceEdit.setUnsavedChangesFunction(),llm.licenceEdit.setDoRefreshAfterSaveFunction()}),document.querySelector("#is-add-transaction-button").addEventListener("click",()=>{let t;const n=n=>{n&&n.preventDefault(),cityssm.postJSON(e+"/licences/doAddTransaction",t,e=>{e.success&&window.location.reload()})};cityssm.openHtmlModal("licence-transactionAdd",{onshow(e){llm.getDefaultConfigProperty("externalReceiptNumber_fieldLabel",t=>{e.querySelector("label[for='transactionAdd--externalReceiptNumber']").textContent=t}),document.querySelector("#transactionAdd--licenceID").value=a;const o=Number.parseFloat(document.querySelector("#licence--licenceFee").value),c=document.querySelector("#licence--transactionTotal"),s=Number.parseFloat(c?c.textContent:"0");document.querySelector("#transactionAdd--licenceFee").textContent=o.toFixed(2),document.querySelector("#transactionAdd--transactionTotal").textContent=s.toFixed(2);const r=(o-s).toFixed(2);if(document.querySelector("#transactionAdd--discrepancy").textContent=r,document.querySelector("#transactionAdd--transactionAmount").value=r,(t=e.querySelector("form")).addEventListener("submit",n),!i){const e=document.querySelector("#is-add-transaction-issue-licence-button");e.classList.remove("is-hidden"),e.addEventListener("click",()=>{document.querySelector("#transactionAdd--issueLicence").value="true",n()})}}})});const n=document.querySelector("#is-void-transaction-button");n&&n.addEventListener("click",()=>{if(r)return void cityssm.alertModal("Unsaved Changes","Please save all unsaved changes before issuing this licence.","OK","warning");const t=(-1*Number.parseFloat(n.dataset.transactionAmount)).toFixed(2);cityssm.confirmModal("Void Transaction?","<strong>Are you sure you want to void this transaction?</strong><br />If the history of this transaction should be maintained, it may be preferred to create a new transaction for $ "+t+".","Void Transaction","warning",()=>{cityssm.postJSON(e+"/licences/doVoidTransaction",{licenceID:a,transactionIndex:n.dataset.transactionIndex},e=>{e.success&&window.location.reload()})})})}if(!o){const t=document.querySelector("#is-unissue-licence-button");if(t)t.addEventListener("click",()=>{cityssm.confirmModal("Unissue Licence?","Are you sure you want to unissue this lottery licence?","Yes, Unissue","danger",()=>{cityssm.postJSON(e+"/licences/doUnissueLicence",{licenceID:a},e=>{e.success&&window.location.reload()})})});else{const t=()=>{cityssm.postJSON(e+"/licences/doIssueLicence",{licenceID:a},e=>{e.success&&window.location.reload()})},n=()=>{r?cityssm.alertModal("Unsaved Changes","Please save all unsaved changes before issuing this licence.","OK","warning"):cityssm.confirmModal("Issue Licence?","Are you sure you want to issue this lottery licence?","Yes, Issue","success",t)};document.querySelector("#is-issue-licence-button").addEventListener("click",n),document.querySelector("#is-not-issued-tag").addEventListener("dblclick",n)}}})(),Object.defineProperty(exports,"__esModule",{value:!0}),document.querySelector("#is-ticket-types-panel")){const e=document.querySelector("main").dataset.urlPrefix,t=document.querySelector("#form--licence"),n=""===document.querySelector("#licence--licenceID").value,a=document.querySelector("#is-ticket-types-panel"),o=document.querySelector("#licence--licenceTypeKey"),i=new Map,c=t=>{const n=o.value;i.has(n)?t(i.get(n)):cityssm.postJSON(e+"/licences/doGetTicketTypes",{licenceTypeKey:n},e=>{i.set(n,e),t(e)})},s=[];let r;const l=[];let d;const u=e=>{0===s.length?llm.licenceEdit.loadLocationListFunction(t=>{r=new Map;for(const e of t)e.locationIsDistributor&&(s.push(e),r.set(e.locationID,e.locationDisplayName));e(s)}):e(s)},m=e=>{0===l.length?llm.licenceEdit.loadLocationListFunction(t=>{d=new Map;for(const e of t)e.locationIsManufacturer&&(l.push(e),d.set(e.locationID,e.locationDisplayName));e(l)}):e(l)},p=document.querySelector("#ticketTypesTabPanel--summary"),y=p.querySelector("tbody"),v=p.querySelector("tfoot"),f=document.querySelector("#ticketTypesTabPanel--log"),g=f.querySelector("tbody"),h=f.querySelector("tfoot");let b="",S="";if(g.querySelectorAll("tr").length>0){const e=g.querySelectorAll("tr"),t=e[e.length-1];b=t.dataset.distributorId,S=t.dataset.manufacturerId}const L=()=>{const e=new Map,t=g.querySelectorAll("tr");for(const n of t){const t=n.getAttribute("data-ticket-type");let a=Number.parseInt(n.getAttribute("data-unit-count"),10),o=Number.parseFloat(n.getAttribute("data-total-value")),i=Number.parseFloat(n.getAttribute("data-total-prizes")),c=Number.parseFloat(n.getAttribute("data-licence-fee"));e.has(t)&&(a+=e.get(t).totalUnits,o+=e.get(t).totalValue,i+=e.get(t).totalPrizes,c+=e.get(t).totalLicenceFee),e.set(t,{totalUnits:a,totalValue:o,totalPrizes:i,totalLicenceFee:c})}const n=[];for(const t of e.keys())n.push(t);n.sort(),cityssm.clearElement(y);const a={totalUnits:0,totalValue:0,totalPrizes:0,totalLicenceFee:0};for(const t of n){const n=e.get(t);a.totalUnits+=n.totalUnits,a.totalValue+=n.totalValue,a.totalPrizes+=n.totalPrizes,a.totalLicenceFee+=n.totalLicenceFee;const o=document.createElement("tr");o.innerHTML="<td>"+t+'</td><td class="has-text-right">'+n.totalUnits.toString()+'</td><td class="has-text-right">'+llm.formatDollarsAsHTML(n.totalValue)+'</td><td class="has-text-right">'+llm.formatDollarsAsHTML(n.totalPrizes)+'</td><td class="has-text-right">'+llm.formatDollarsAsHTML(n.totalLicenceFee)+"</td>",y.append(o)}v.innerHTML='<td></td><th class="has-text-right">'+a.totalUnits.toString()+'</th><th class="has-text-right">'+llm.formatDollarsAsHTML(a.totalValue)+'</th><th class="has-text-right">'+llm.formatDollarsAsHTML(a.totalPrizes)+'</th><th class="has-text-right">'+llm.formatDollarsAsHTML(a.totalLicenceFee)+"</th>",h.innerHTML='<td></td><td></td><th class="has-text-right">'+a.totalUnits.toString()+'</th><th class="has-text-right">'+llm.formatDollarsAsHTML(a.totalValue)+'</th><th class="has-text-right">'+llm.formatDollarsAsHTML(a.totalPrizes)+'</th><th class="has-text-right">'+llm.formatDollarsAsHTML(a.totalLicenceFee)+'</th><td></td><td class="is-hidden-print"></td>',document.querySelector("#licence--totalPrizeValue").value=a.totalPrizes.toFixed(2)},k=e=>{const t=e.ticketType,n=e.unitCount,a=e.valuePerDeal,o=(a*n).toFixed(2),i=e.prizesPerDeal,c=(i*n).toFixed(2),s=e.licenceFee,l=document.createElement("tr");l.className="has-background-success-light",l.dataset.ticketTypeIndex="",l.dataset.ticketType=t,l.dataset.unitCount=n.toString(),l.dataset.totalValue=o.toString(),l.dataset.totalPrizes=c.toString(),l.dataset.licenceFee=e.licenceFee.toString(),l.insertAdjacentHTML("beforeend",'<td><input name="ticketType_ticketTypeIndex" type="hidden" value="" /><input name="ticketType_amendmentDate" type="hidden" value="" /><span>(New Record)</span></td>'),l.insertAdjacentHTML("beforeend",'<td><input name="ticketType_ticketType" type="hidden" value="'+cityssm.escapeHTML(t)+'" /><span>'+cityssm.escapeHTML(t)+"</span></td>"),l.insertAdjacentHTML("beforeend",'<td class="has-text-right"><input name="ticketType_unitCount" type="hidden" value="'+n.toString()+'" /><span>'+n.toString()+"</span></td>"),l.insertAdjacentHTML("beforeend",'<td class="has-text-right is-nowrap"><input class="is-total-value-per-deal" type="hidden" value="'+o.toString()+'" /><span data-tooltip="$'+a.toFixed(2)+' value per deal">$ '+o+"</span></td>"),l.insertAdjacentHTML("beforeend",'<td class="has-text-right is-nowrap"><input class="is-total-prizes-per-deal" type="hidden" value="'+c.toString()+'" /><span data-tooltip="$'+i.toFixed(2)+' prizes per deal">$'+c+"</span></td>"),l.insertAdjacentHTML("beforeend",'<td class="has-text-right is-nowrap"><input class="is-licence-fee" name="ticketType_licenceFee" type="hidden" value="'+s.toString()+'" /><span>$'+s.toFixed(2)+"</span></td>");const u=d.get(e.manufacturerLocationID),m=r.get(e.distributorLocationID);b=e.distributorLocationID.toString(),S=e.manufacturerLocationID.toString(),l.insertAdjacentHTML("beforeend",'<td class="is-size-7"><input name="ticketType_manufacturerLocationID" type="hidden" value="'+e.manufacturerLocationID.toString()+'" /><input name="ticketType_distributorLocationID" type="hidden" value="'+e.distributorLocationID.toString()+'" /><span>'+cityssm.escapeHTML(u)+"<span><br /><span>"+cityssm.escapeHTML(m)+"<span></td>"),l.insertAdjacentHTML("beforeend",'<td class="is-hidden-print"><button class="button is-small is-danger has-tooltip-left is-delete-ticket-type-button" data-tooltip="Delete Ticket Type" type="button"><i class="fas fa-trash" aria-hidden="true"></i><span class="sr-only">Delete</span></button></td>'),l.querySelector(".is-delete-ticket-type-button").addEventListener("click",q),g.prepend(l),L(),llm.licenceEdit.setUnsavedChangesFunction(),llm.licenceEdit.setDoRefreshAfterSaveFunction()},T=e=>{const a=e.dataset.ticketTypeIndex;e.remove(),n||t.insertAdjacentHTML("beforeend",'<input class="is-removed-after-save" name="ticketTypeIndex_toDelete" type="hidden" value="'+cityssm.escapeHTML(a)+'" />'),L(),llm.licenceEdit.setUnsavedChangesFunction(),llm.licenceEdit.setDoRefreshAfterSaveFunction()},q=e=>{const t=e.currentTarget.closest("tr"),n=t.dataset.ticketType;cityssm.confirmModal("Delete Ticket Type?","Are you sure you want to remove the "+n+" ticket type for this licence?","Yes, Delete","danger",()=>{T(t)})},A=e=>{const t={manufacturerLocationId:S,distributorLocationId:b,ticketType:"",unitCount:"1"};let n,a,o,i;"is-add-ticket-type-button"!==e.currentTarget.id&&(n=e.currentTarget.closest("tr"),t.manufacturerLocationId=n.dataset.manufacturerId,t.distributorLocationId=n.dataset.distributorId,t.ticketType=n.dataset.ticketType,t.unitCount=n.dataset.unitCount);const s=e=>{e.preventDefault(),k({ticketType:document.querySelector("#ticketTypeAdd--ticketType").value,unitCount:Number.parseInt(document.querySelector("#ticketTypeAdd--unitCount").value,10),valuePerDeal:Number.parseFloat(document.querySelector("#ticketTypeAdd--valuePerDeal").value),prizesPerDeal:Number.parseFloat(document.querySelector("#ticketTypeAdd--prizesPerDeal").value),licenceFee:Number.parseFloat(document.querySelector("#ticketTypeAdd--licenceFee").value),distributorLocationID:Number.parseInt(document.querySelector("#ticketTypeAdd--distributorLocationID").value,10),manufacturerLocationID:Number.parseInt(document.querySelector("#ticketTypeAdd--manufacturerLocationID").value,10)}),n&&T(n),a()},r=()=>{const e=Number.parseInt(i.value,10);document.querySelector("#ticketTypeAdd--prizesTotal").value=(Number.parseFloat(document.querySelector("#ticketTypeAdd--prizesPerDeal").value)*e).toFixed(2),document.querySelector("#ticketTypeAdd--licenceFee").value=(Number.parseFloat(document.querySelector("#ticketTypeAdd--feePerUnit").value)*e).toFixed(2)},l=()=>{const e=o.selectedOptions[0];document.querySelector("#ticketTypeAdd--ticketPrice").value=e.getAttribute("data-ticket-price"),document.querySelector("#ticketTypeAdd--ticketCount").value=e.getAttribute("data-ticket-count"),document.querySelector("#ticketTypeAdd--valuePerDeal").value=(Number.parseFloat(e.getAttribute("data-ticket-price"))*Number.parseInt(e.getAttribute("data-ticket-count"),10)).toFixed(2),document.querySelector("#ticketTypeAdd--prizesPerDeal").value=e.getAttribute("data-prizes-per-deal"),document.querySelector("#ticketTypeAdd--feePerUnit").value=e.getAttribute("data-fee-per-unit"),r()};cityssm.openHtmlModal("licence-ticketTypeAdd",{onshow(e){o=e.querySelector("#ticketTypeAdd--ticketType"),i=e.querySelector("#ticketTypeAdd--unitCount"),u(e=>{const n=document.querySelector("#ticketTypeAdd--distributorLocationID");n.innerHTML='<option value="">(No Distributor)</option>';for(const t of e)n.insertAdjacentHTML("beforeend",'<option value="'+t.locationID.toString()+'">'+cityssm.escapeHTML(t.locationDisplayName)+"</option>");""!==t.distributorLocationId&&n.querySelector("[value='"+b+"']")&&(n.value=t.distributorLocationId)}),m(e=>{const n=document.querySelector("#ticketTypeAdd--manufacturerLocationID");n.innerHTML='<option value="">(No Manufacturer)</option>';for(const t of e)n.insertAdjacentHTML("beforeend",'<option value="'+t.locationID.toString()+'">'+cityssm.escapeHTML(t.locationDisplayName)+"</option>");""!==t.manufacturerLocationId&&n.querySelector("[value='"+S+"']")&&(n.value=t.manufacturerLocationId)}),c(e=>{if(!e||0===e.length)return a(),void cityssm.alertModal("No ticket types available","","OK","danger");o.innerHTML="";for(const t of e){const e=document.createElement("option");e.dataset.ticketPrice=t.ticketPrice.toFixed(2),e.dataset.ticketCount=t.ticketCount.toString(),e.dataset.prizesPerDeal=t.prizesPerDeal.toFixed(2),e.dataset.feePerUnit=(t.feePerUnit||0).toFixed(2),e.value=t.ticketType,e.textContent=t.ticketType+" ("+t.ticketCount.toString()+" tickets, $"+t.ticketPrice.toFixed(2)+" each)",o.append(e)}""!==t.ticketType&&(o.value=t.ticketType),l()}),""!==t.unitCount&&(i.value=t.unitCount,r()),n&&(e.querySelector(".modal-card-title").textContent="Edit a Ticket Type",e.querySelector(".modal-card-body").insertAdjacentHTML("afterbegin",'<div class="message is-warning"><p class="message-body">Note that editing ticket type records can negatively impact your historical reporting.</p></div>'),e.querySelector(".modal-card-foot .button[type='submit']").innerHTML='<span class="icon"><i class="fas fa-save" aria-hidden="true"></i></span><span>Edit Ticket Type</span>'),o.addEventListener("change",l),i.addEventListener("change",r),e.querySelector("form").addEventListener("submit",s)},onshown(e,t){a=t}})};L(),document.querySelector("#is-add-ticket-type-button").addEventListener("click",A);const D=a.querySelectorAll(".is-edit-ticket-type-button");for(const e of D)e.addEventListener("click",A);const E=a.querySelectorAll(".is-delete-ticket-type-button");for(const e of E)e.addEventListener("click",q)}