(function(){function f(a){window.llm.enableNavBlocker();x.innerHTML='<div class="has-text-info"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i> Unsaved Changes</div>';m&&a&&"number"===a.currentTarget.type&&(m.getElementsByTagName("fieldset")[0].setAttribute("disabled","disabled"),u=!0)}function N(a){a.preventDefault();a=a.currentTarget;document.getElementById("licence--organizationID").value=a.getAttribute("data-organization-id");document.getElementById("licence--organizationName").value=
a.getAttribute("data-organization-name");window.llm.hideModal(a);f()}function F(){var a=document.createElement("div");a.className="list is-hoverable";for(var e=y.value.trim().toLowerCase().split(" "),n=10,c=0;c<v.length&&0<n;c+=1){var g=!0,b=v[c];if(b.isEligibleForLicences){for(var h=b.organizationName.toLowerCase(),d=0;d<e.length;d+=1)if(-1===h.indexOf(e[d])){g=!1;break}g&&(--n,g=document.createElement("a"),g.className="list-item",g.setAttribute("data-organization-id",b.organizationID),g.setAttribute("data-organization-name",
b.organizationName),g.innerText=b.organizationName,g.addEventListener("click",N),a.insertAdjacentElement("beforeend",g))}}window.llm.clearElement(G);G.insertAdjacentElement("beforeend",a)}function H(a,e){document.getElementById("licence--locationID").value=a;document.getElementById("licence--locationDisplayName").value=e}function O(a){a.preventDefault();a=a.currentTarget;H(a.getAttribute("data-location-id"),a.getAttribute("data-location-display-name"));window.llm.hideModal(a);f()}function I(){var a=
document.createElement("div");a.className="list is-hoverable";for(var e=z.value.trim().toLowerCase().split(" "),n=10,b=0;b<p.length&&0<n;b+=1){for(var c=!0,d=p[b],h=d.locationName.toLowerCase(),f=0;f<e.length;f+=1)if(-1===h.indexOf(e[f])){c=!1;break}c&&(--n,c=""===d.locationName?d.locationAddress1:d.locationName,h=document.createElement("a"),h.className="list-item",h.setAttribute("data-location-id",d.locationID),h.setAttribute("data-location-display-name",c),h.innerHTML=c+(""===d.locationName?"":
"<br /><small>"+d.locationAddress1+"</small>"),h.addEventListener("click",O),a.insertAdjacentElement("beforeend",h))}window.llm.clearElement(J);J.insertAdjacentElement("beforeend",a)}function P(a){a.preventDefault();a=parseInt(a.currentTarget.getAttribute("data-terms-conditions-index"));document.getElementById("licence--termsConditions").value=k[a].termsConditions;window.llm.hideModal(A);f()}function Q(a){a.currentTarget.closest(".panel-block").remove();u=!0;f()}function K(a){var e="";if(a)if(a instanceof
Date)e=a.getFullYear()+"-"+("00"+(a.getMonth()+1)).slice(-2)+"-"+("00"+a.getDate()).slice(-2);else if(a.constructor===String)e=a;else if(a instanceof Object)try{a.preventDefault();var c=a.currentTarget.getAttribute("data-source"),e=document.getElementById(c).value}catch(T){}q.insertAdjacentHTML("beforeend",'<div class="panel-block is-block"><div class="field has-addons">'+('<div class="control is-expanded has-icons-left"><input class="input is-small" name="eventDate" type="date" value="'+e+'" min="'+
r.value+'" max="'+d.value+'" required /><span class="icon is-left"><i class="fas fa-calendar" aria-hidden="true"></i></span></div>')+'<div class="control"><a class="button is-small is-danger has-tooltip-right" role="button" data-tooltip="Remove Event"><i class="fas fa-trash" aria-hidden="true"></i><span class="sr-only">Remove Event</span></a></div></div></div>');a=q.getElementsByTagName("a");a[a.length-1].addEventListener("click",Q);u=!0;f()}var B=document.getElementById("form--licence"),x=document.getElementById("container--form-message"),
C=document.getElementById("licence--licenceID").value,D=""===C,m=document.getElementById("form--licenceFee"),u=!1,q=document.getElementById("container--events");B.addEventListener("submit",function(a){a.preventDefault();0===q.getElementsByTagName("input").length?window.llm.alertModal("Event Date Error","Please ensure there is at least one event date.","OK","warning"):(x.innerHTML='Saving... <i class="fas fa-circle-notch fa-spin" aria-hidden="true"></i>',window.fetch("/licences/doSave",{method:"POST",
credentials:"include",body:new URLSearchParams(new FormData(B))}).then(function(a){return a.json()}).then(function(a){a.success&&window.llm.disableNavBlocker();a.success&&D?window.location.href="/licences/"+a.licenceID+"/edit":a.success&&u?window.location.reload(!0):(x.innerHTML="",window.llm.alertModal(a.message,"","OK",a.success?"success":"danger"))}))});D||document.getElementsByClassName("is-delete-button")[0].addEventListener("click",function(a){a.preventDefault();window.llm.confirmModal("Delete Licence?",
"Are you sure you want to delete this licence and all events associated with it?","Yes, Delete","danger",function(){window.fetch("/licences/doDelete",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({licenceID:C})}).then(function(a){return a.json()}).then(function(a){a.success&&(window.llm.disableNavBlocker(),window.location.href="/licences")})})});for(var b=B.querySelectorAll("input, select, textarea"),c=0;c<b.length;c+=1)""!==b[c].name&&b[c].addEventListener("change",
f);b=document.getElementsByClassName("is-external-licence-number-unlock-button");b.length&&b[0].addEventListener("click",function(){var a=document.getElementById("licence--externalLicenceNumber");a.classList.remove("has-background-light");a.classList.remove("has-cursor-not-allowed");a.removeAttribute("readonly");a.focus()});var v=[],L=document.getElementsByClassName("is-organization-lookup-modal")[0],y=document.getElementById("organizationLookup--searchStr"),G=document.getElementById("container--organizationLookup");
y.addEventListener("keyup",F);document.getElementsByClassName("is-organization-lookup-button")[0].addEventListener("click",function(){0===v.length&&window.fetch("/organizations/doGetAll",{method:"GET",credentials:"include"}).then(function(a){return a.json()}).then(function(a){v=a;y.removeAttribute("disabled");F()});window.llm.showModal(L)});b=L.getElementsByClassName("is-close-modal-button");for(c=0;c<b.length;c+=1)b[c].addEventListener("click",window.llm.hideModal);var p=[],w=document.getElementById("is-location-lookup-modal"),
z=document.getElementById("locationLookup--searchStr"),J=document.getElementById("container--locationLookup"),M=document.getElementById("form--newLocation");z.addEventListener("keyup",I);M.addEventListener("submit",function(a){a.preventDefault();window.fetch("/locations/doCreate",{method:"POST",credentials:"include",body:new URLSearchParams(new FormData(M))}).then(function(a){return a.json()}).then(function(a){a.success&&(p=[],H(a.locationID,a.locationDisplayName),window.llm.hideModal(w))})});document.getElementsByClassName("is-location-lookup-button")[0].addEventListener("click",
function(){0===p.length&&window.fetch("/locations/doGetLocations",{method:"GET",credentials:"include"}).then(function(a){return a.json()}).then(function(a){p=a;z.removeAttribute("disabled");I()});window.llm.showModal(w)});b=w.getElementsByClassName("is-close-modal-button");for(c=0;c<b.length;c+=1)b[c].addEventListener("click",window.llm.hideModal);window.llm.initializeTabs(w.querySelector(".tabs ul"));var k=[],A=document.getElementById("is-termsConditions-lookup-modal"),t=document.getElementById("container--termsConditionsPrevious");
document.getElementsByClassName("is-termsConditions-lookup-button")[0].addEventListener("click",function(){k=[];window.llm.clearElement(t);var a=document.getElementById("licence--organizationID").value;""===a?window.llm.alertModal("No Organization Selected","An organization must be selected before the previously used terms and conditions can be retrieved.","OK","warning"):(t.innerHTML='<p class="has-text-centered has-text-grey-lighter"><i class="fas fa-3x fa-circle-notch fa-spin" aria-hidden="true"></i><br />Loading previously used terms and conditions...</p>',
window.fetch("/licences/doGetDistinctTermsConditions",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({organizationID:a})}).then(function(a){return a.json()}).then(function(a){k=a;if(0===k.length)t.innerHTML='<p class="has-text-centered">No previously used terms and conditions found for this organization.</p>';else{a=document.createElement("div");a.className="list is-hoverable has-margin-bottom-10";for(var c=0;c<k.length;c+=1){var b=k[c],e=document.createElement("a");
e.className="list-item";e.setAttribute("data-terms-conditions-index",c);e.innerHTML="<p>"+window.llm.escapeHTML(b.termsConditions)+'</p><p class="has-text-right">'+(1<b.termsConditionsCount?'<span class="tag is-light">Used '+b.termsConditionsCount+" times</span>":"")+'<span class="tag is-info">'+b.startDateMaxString+"</span></p>";e.addEventListener("click",P);a.insertAdjacentElement("beforeend",e)}window.llm.clearElement(t);t.insertAdjacentElement("beforeend",a)}}),window.llm.showModal(A))});b=A.getElementsByClassName("is-close-modal-button");
for(c=0;c<b.length;c+=1)b[c].addEventListener("click",window.llm.hideModal);var b=document.getElementById("licence--licenceTypeKey"),l=document.getElementsByClassName("container-licenceTypeFields");b.addEventListener("change",function(a){a="container-licenceTypeFields--"+a.currentTarget.value;for(var c=0;c<l.length;c+=1)l[c].id===a?(l[c].removeAttribute("disabled"),l[c].classList.remove("is-hidden")):(l[c].classList.add("is-hidden"),l[c].setAttribute("disabled","disabled"))});var r=document.getElementById("licence--startDateString"),
d=document.getElementById("licence--endDateString");document.getElementById("licence--applicationDateString").addEventListener("change",function(a){r.setAttribute("min",a.currentTarget.value)});r.addEventListener("change",function(){var a=r.value;d.setAttribute("min",a);d.value<a&&(d.value=a);for(var c=q.getElementsByTagName("input"),b=0;b<c.length;b+=1)c[b].setAttribute("min",a)});d.addEventListener("change",function(){for(var a=d.value,c=q.getElementsByTagName("input"),b=0;b<c.length;b+=1)c[b].setAttribute("max",
a)});var E=document.getElementsByClassName("is-event-calculator-modal")[0];document.getElementsByClassName("is-calculate-events-button")[0].addEventListener("click",function(){for(var a=parseInt(document.getElementById("eventCalc--eventCount").value),c=parseInt(document.getElementById("eventCalc--dayInterval").value),b=d.value.split("-"),f=new Date(b[0],parseInt(b[1])-1,b[2]),b=r.value.split("-"),b=new Date(b[0],parseInt(b[1])-1,b[2]),g=0;g<a&&b.getTime()<=f.getTime();g+=1)K(b),b.setDate(b.getDate()+
c);window.llm.hideModal(E)});document.getElementsByClassName("is-event-calculator-button")[0].addEventListener("click",function(){window.llm.showModal(E)});b=E.getElementsByClassName("is-close-modal-button");for(c=0;c<b.length;c+=1)b[c].addEventListener("click",window.llm.hideModal);b=document.getElementsByClassName("is-add-event-button");for(c=0;c<b.length;c+=1)b[c].addEventListener("click",K);if(!D)if(m){var R=function(){window.fetch("/licences/doMarkLicenceFeePaid",{method:"POST",credentials:"include",
body:new URLSearchParams(new FormData(m))}).then(function(a){return a.json()}).then(function(a){a.success&&(window.llm.disableNavBlocker(),window.location.reload(!0))})};m.addEventListener("submit",function(a){a.preventDefault();window.llm.confirmModal("Mark Fee as Paid?","Are you sure you want to mark the licence fee as paid?","Yes, Paid","info",R)})}else{var S=function(){window.fetch("/licences/doRemoveLicenceFee",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},
body:JSON.stringify({licenceID:C})}).then(function(a){return a.json()}).then(function(a){a.success&&(window.llm.disableNavBlocker(),window.location.reload(!0))})};document.getElementsByClassName("is-remove-licence-fee-button")[0].addEventListener("click",function(){window.llm.confirmModal("Remove Fee Payment?","Are you sure you want to remove the fee payment and change the licence to unpaid?","Yes, Remove Payment","danger",S)})}})();
