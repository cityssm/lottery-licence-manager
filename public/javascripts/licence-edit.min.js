(function(){function l(a){window.llm.enableNavBlocker();B.innerHTML='<div class="has-text-info"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i> Unsaved Changes</div>';p&&a&&"number"===a.currentTarget.type&&(p.getElementsByTagName("fieldset")[0].setAttribute("disabled","disabled"),w=!0)}function Q(a){0===q.length?window.fetch("/locations/doGetLocations",{method:"GET",credentials:"include"}).then(function(a){return a.json()}).then(function(b){q=b;a()}):a()}var C=document.getElementById("form--licence"),
B=document.getElementById("container--form-message"),D=document.getElementById("licence--licenceID").value,x=""===D,p=document.getElementById("form--licenceFee"),w=!1,r=document.getElementById("container--events");C.addEventListener("submit",function(a){a.preventDefault();0===r.getElementsByTagName("input").length?window.llm.alertModal("Event Date Error","Please ensure there is at least one event date.","OK","warning"):(B.innerHTML='Saving... <i class="fas fa-circle-notch fa-spin" aria-hidden="true"></i>',
window.fetch("/licences/doSave",{method:"POST",credentials:"include",body:new URLSearchParams(new FormData(C))}).then(function(a){return a.json()}).then(function(a){a.success&&window.llm.disableNavBlocker();a.success&&x?window.location.href="/licences/"+a.licenceID+"/edit":a.success&&w?window.location.reload(!0):(B.innerHTML="",window.llm.alertModal(a.message,"","OK",a.success?"success":"danger"))}))});x||document.getElementById("is-delete-licence-button").addEventListener("click",function(a){a.preventDefault();
window.llm.confirmModal("Delete Licence?","Are you sure you want to delete this licence and all events associated with it?","Yes, Delete","danger",function(){window.fetch("/licences/doDelete",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({licenceID:D})}).then(function(a){return a.json()}).then(function(a){a.success&&(window.llm.disableNavBlocker(),window.location.href="/licences")})})});for(var e=C.querySelectorAll("input, select, textarea"),
d=0;d<e.length;d+=1)""!==e[d].name&&e[d].addEventListener("change",l);(e=document.getElementById("is-external-licence-number-unlock-button"))&&e.addEventListener("click",function(){var a=document.getElementById("licence--externalLicenceNumber");a.classList.remove("is-readonly");a.removeAttribute("readonly");a.focus()});var y=[],L,t,E,R=function(a){a.preventDefault();a=a.currentTarget;document.getElementById("licence--organizationID").value=a.getAttribute("data-organization-id");document.getElementById("licence--organizationName").value=
a.getAttribute("data-organization-name");L();l()},F=function(){var a=document.createElement("div");a.className="list is-hoverable";for(var b=t.value.trim().toLowerCase().split(" "),c=10,z=0;z<y.length&&0<c;z+=1){var f=!0,d=y[z];if(d.isEligibleForLicences){for(var e=d.organizationName.toLowerCase(),g=0;g<b.length;g+=1)if(-1===e.indexOf(b[g])){f=!1;break}f&&(--c,f=document.createElement("a"),f.className="list-item",f.setAttribute("data-organization-id",d.organizationID),f.setAttribute("data-organization-name",
d.organizationName),f.innerText=d.organizationName,f.addEventListener("click",R),a.insertAdjacentElement("beforeend",f))}}window.llm.clearElement(E);E.insertAdjacentElement("beforeend",a)};document.getElementById("is-organization-lookup-button").addEventListener("click",function(){window.llm.openHtmlModal("licence-organizationLookup",{onshow:function(){t=document.getElementById("organizationLookup--searchStr");t.addEventListener("keyup",F);E=document.getElementById("container--organizationLookup");
0===y.length?window.fetch("/organizations/doGetAll",{method:"GET",credentials:"include"}).then(function(a){return a.json()}).then(function(a){y=a;t.removeAttribute("disabled");F()}):(t.removeAttribute("disabled"),F())},onshown:function(a,b){L=b}})});var q=[],G,A,H,M=function(a,b){document.getElementById("licence--locationID").value=a;document.getElementById("licence--locationDisplayName").value=b},S=function(a){a.preventDefault();a=a.currentTarget;M(a.getAttribute("data-location-id"),a.getAttribute("data-location-display-name"));
G();l()},N=function(){var a=document.createElement("div");a.className="list is-hoverable";for(var b=A.value.trim().toLowerCase().split(" "),c=10,d=0;d<q.length&&0<c;d+=1){for(var f=!0,e=q[d],h=e.locationName.toLowerCase(),g=0;g<b.length;g+=1)if(-1===h.indexOf(b[g])){f=!1;break}f&&(--c,f=""===e.locationName?e.locationAddress1:e.locationName,h=document.createElement("a"),h.className="list-item",h.setAttribute("data-location-id",e.locationID),h.setAttribute("data-location-display-name",f),h.innerHTML=
f+(""===e.locationName?"":"<br /><small>"+e.locationAddress1+"</small>"),h.addEventListener("click",S),a.insertAdjacentElement("beforeend",h))}window.llm.clearElement(H);H.insertAdjacentElement("beforeend",a)};document.getElementById("is-location-lookup-button").addEventListener("click",function(){window.llm.openHtmlModal("licence-locationLookup",{onshow:function(a){A=document.getElementById("locationLookup--searchStr");A.addEventListener("keyup",N);H=document.getElementById("container--locationLookup");
Q(function(){A.removeAttribute("disabled");N()});window.llm.getDefaultConfigProperty("city",function(a){a&&(document.getElementById("newLocation--locationCity").value=a)});window.llm.getDefaultConfigProperty("province",function(a){a&&(document.getElementById("newLocation--locationProvince").value=a)});document.getElementById("form--newLocation").addEventListener("submit",function(a){a.preventDefault();window.fetch("/locations/doCreate",{method:"POST",credentials:"include",body:new URLSearchParams(new FormData(a.currentTarget))}).then(function(a){return a.json()}).then(function(a){a.success&&
(q=[],M(a.locationID,a.locationDisplayName),G())})});window.llm.initializeTabs(a.querySelector(".tabs ul"))},onshown:function(a,b){G=b}})});var m=[],I=document.getElementById("is-termsConditions-lookup-modal"),u=document.getElementById("container--termsConditionsPrevious"),T=function(a){a.preventDefault();a=parseInt(a.currentTarget.getAttribute("data-terms-conditions-index"));document.getElementById("licence--termsConditions").value=m[a].termsConditions;window.llm.hideModal(I);l()};document.getElementById("is-termsConditions-lookup-button").addEventListener("click",
function(){m=[];window.llm.clearElement(u);var a=document.getElementById("licence--organizationID").value;""===a?window.llm.alertModal("No Organization Selected","An organization must be selected before the previously used terms and conditions can be retrieved.","OK","warning"):(u.innerHTML='<p class="has-text-centered has-text-grey-lighter"><i class="fas fa-3x fa-circle-notch fa-spin" aria-hidden="true"></i><br />Loading previously used terms and conditions...</p>',window.fetch("/licences/doGetDistinctTermsConditions",
{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({organizationID:a})}).then(function(a){return a.json()}).then(function(a){m=a;if(0===m.length)u.innerHTML='<p class="has-text-centered">No previously used terms and conditions found for this organization.</p>';else{a=document.createElement("div");a.className="list is-hoverable has-margin-bottom-10";for(var c=0;c<m.length;c+=1){var b=m[c],d=document.createElement("a");d.className="list-item";d.setAttribute("data-terms-conditions-index",
c);d.innerHTML="<p>"+window.llm.escapeHTML(b.termsConditions)+'</p><p class="has-text-right">'+(1<b.termsConditionsCount?'<span class="tag is-light">Used '+b.termsConditionsCount+" times</span>":"")+'<span class="tag is-info">'+b.startDateMaxString+"</span></p>";d.addEventListener("click",T);a.insertAdjacentElement("beforeend",d)}window.llm.clearElement(u);u.insertAdjacentElement("beforeend",a)}}),window.llm.showModal(I))});e=I.getElementsByClassName("is-close-modal-button");for(d=0;d<e.length;d+=
1)e[d].addEventListener("click",window.llm.hideModal);var O=document.getElementById("licence--licenceTypeKey");if(x){var n=document.getElementsByClassName("container-licenceTypeFields");O.addEventListener("change",function(a){var b="true"===a.currentTarget.selectedOptions[0].getAttribute("data-has-ticket-types"),c=document.getElementById("licence--totalPrizeValue");b?(document.getElementById("is-ticket-types-panel").classList.remove("is-hidden"),c.setAttribute("readonly","readonly"),c.classList.add("is-readonly")):
(document.getElementById("is-ticket-types-panel").classList.add("is-hidden"),c.removeAttribute("readonly"),c.classList.remove("is-readonly"));a="container-licenceTypeFields--"+a.currentTarget.value;for(b=0;b<n.length;b+=1)n[b].id===a?(n[b].removeAttribute("disabled"),n[b].classList.remove("is-hidden")):(n[b].classList.add("is-hidden"),n[b].setAttribute("disabled","disabled"))})}var v=document.getElementById("licence--startDateString"),k=document.getElementById("licence--endDateString");document.getElementById("licence--applicationDateString").addEventListener("change",
function(a){v.setAttribute("min",a.currentTarget.value)});v.addEventListener("change",function(){var a=v.value;k.setAttribute("min",a);k.value<a&&(k.value=a);for(var b=r.getElementsByTagName("input"),c=0;c<b.length;c+=1)b[c].setAttribute("min",a)});k.addEventListener("change",function(){for(var a=k.value,b=r.getElementsByTagName("input"),c=0;c<b.length;c+=1)b[c].setAttribute("max",a)});var U=function(a){a.currentTarget.closest(".panel-block").remove();w=!0;l()},P=function(a){var b="";if(a)if(a instanceof
Date)b=a.getFullYear()+"-"+("00"+(a.getMonth()+1)).slice(-2)+"-"+("00"+a.getDate()).slice(-2);else if(a.constructor===String)b=a;else if(a instanceof Object)try{a.preventDefault();var c=a.currentTarget.getAttribute("data-source"),b=document.getElementById(c).value}catch(z){}r.insertAdjacentHTML("beforeend",'<div class="panel-block is-block"><div class="field has-addons">'+('<div class="control is-expanded has-icons-left"><input class="input is-small" name="eventDate" type="date" value="'+b+'" min="'+
v.value+'" max="'+k.value+'" required /><span class="icon is-left"><i class="fas fa-calendar" aria-hidden="true"></i></span></div>')+'<div class="control"><a class="button is-small is-danger has-tooltip-right" role="button" data-tooltip="Remove Event"><i class="fas fa-trash" aria-hidden="true"></i><span class="sr-only">Remove Event</span></a></div></div></div>');a=r.getElementsByTagName("a");a[a.length-1].addEventListener("click",U);w=!0;l()},J=document.getElementById("is-event-calculator-modal");
document.getElementsByClassName("is-calculate-events-button")[0].addEventListener("click",function(){for(var a=parseInt(document.getElementById("eventCalc--eventCount").value),b=parseInt(document.getElementById("eventCalc--dayInterval").value),c=k.value.split("-"),d=new Date(c[0],parseInt(c[1])-1,c[2]),c=v.value.split("-"),c=new Date(c[0],parseInt(c[1])-1,c[2]),e=0;e<a&&c.getTime()<=d.getTime();e+=1)P(c),c.setDate(c.getDate()+b);window.llm.hideModal(J)});document.getElementById("is-event-calculator-button").addEventListener("click",
function(){window.llm.showModal(J)});e=J.getElementsByClassName("is-close-modal-button");for(d=0;d<e.length;d+=1)e[d].addEventListener("click",window.llm.hideModal);e=document.getElementsByClassName("is-add-event-button");for(d=0;d<e.length;d+=1)e[d].addEventListener("click",P);if(document.getElementById("is-ticket-types-panel")){var K={};document.getElementById("is-add-ticket-type-button").addEventListener("click",function(){var a,b,c,d=O.value,e=function(a){a.preventDefault()},k=function(){var a=
c.value;document.getElementById("ticketTypeAdd--prizesTotal").value=(document.getElementById("ticketTypeAdd--prizesPerDeal").value*a).toFixed(2);document.getElementById("ticketTypeAdd--licenceFee").value=(document.getElementById("ticketTypeAdd--feePerUnit").value*a).toFixed(2)},h=function(){var a=b.selectedOptions[0];document.getElementById("ticketTypeAdd--ticketPrice").value=a.getAttribute("data-ticket-price");document.getElementById("ticketTypeAdd--ticketCount").value=a.getAttribute("data-ticket-count");
document.getElementById("ticketTypeAdd--valuePerDeal").value=(a.getAttribute("data-ticket-price")*a.getAttribute("data-ticket-count")).toFixed(2);document.getElementById("ticketTypeAdd--prizesPerDeal").value=a.getAttribute("data-prizes-per-deal");document.getElementById("ticketTypeAdd--feePerUnit").value=a.getAttribute("data-fee-per-unit");k()},g=function(){var c=K[d];if(c&&0!==c.length){for(var e=0;e<c.length;e+=1){var f=c[e],g=document.createElement("option");g.setAttribute("data-ticket-price",
f.ticketPrice.toFixed(2));g.setAttribute("data-ticket-count",f.ticketCount);g.setAttribute("data-prizes-per-deal",f.prizesPerDeal.toFixed(2));g.setAttribute("data-fee-per-unit",(f.feePerUnit||0).toFixed(2));g.value=f.ticketType;g.innerText=f.ticketType;b.insertAdjacentElement("beforeend",g)}h()}else a(),window.llm.alertModal("No ticket types available","","OK","danger")};window.llm.openHtmlModal("licence-ticketTypeAdd",{onshow:function(a){b=document.getElementById("ticketTypeAdd--ticketType");b.addEventListener("change",
h);c=document.getElementById("ticketTypeAdd--unitCount");c.addEventListener("change",k);a.getElementsByTagName("form")[0].addEventListener("submit",e)},onshown:function(c,b){a=b;d in K?g():window.fetch("/licences/doGetTicketTypes",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({licenceTypeKey:d})}).then(function(a){return a.json()}).then(function(a){K[d]=a;g()})}})})}if(!x)if(p){var V=function(){window.fetch("/licences/doMarkLicenceFeePaid",{method:"POST",
credentials:"include",body:new URLSearchParams(new FormData(p))}).then(function(a){return a.json()}).then(function(a){a.success&&(window.llm.disableNavBlocker(),window.location.reload(!0))})};p.addEventListener("submit",function(a){a.preventDefault();window.llm.confirmModal("Mark Fee as Paid?","Are you sure you want to mark the licence fee as paid?","Yes, Paid","info",V)})}else{var W=function(){window.fetch("/licences/doRemoveLicenceFee",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},
body:JSON.stringify({licenceID:D})}).then(function(a){return a.json()}).then(function(a){a.success&&(window.llm.disableNavBlocker(),window.location.reload(!0))})};document.getElementById("is-remove-licence-fee-button").addEventListener("click",function(){window.llm.confirmModal("Remove Fee Payment?","Are you sure you want to remove the fee payment and change the licence to unpaid?","Yes, Remove Payment","danger",W)})}})();
